# R - o básico

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "basics_header_close.png"))
```

Bem-vindo!

Esta página analisa o essencial de R. Não pretende ser um tutorial abrangente, mas fornece o básico e pode ser útil para refrescar a sua memória. A secção [Recurso para a aprendizagem](#learning) liga a tutoriais mais abrangentes.

Partes desta página foram adaptadas com a permissão do [projecto R4Epis](https://r4epis.netlify.app/).

Ver a página em [Transição para R] para dicas sobre como mudar para R de STATA, SAS, ou Excel.

Traduzido com a versão gratuita do tradutor - www.DeepL.com/Translator

```{r, echo=F}
# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
pacman::p_load(apyramid)
```

<!-- ======================================================= -->

## Porque usar o R?

Segundo a definição do site [*R project*](https://www.r-project.org/about.html),  R é uma linguagem de programação e também um ambiente para computação estatística e gráfica. É altamente versátil, extensível, e orientado para a comunidade.

**Custo**

R é de utilização livre! Há uma política forte na comunidade para que o material seja gratuito e de fonte aberta.

**Reprodutibilidade**

A prática de conduzir a análise e gestão dos dados poor meio de uma linguagem de programação (em comparação com o Excel ou outra dessas ferramentas que requerem cliques manuais) melhora a  **reprodutibilidade**, torna a **detecção de erros** mais fácil, e alivia sua carga de trabalho.

**Comunidade**

A comunidade de usuários de R é enorme e colaborativa. Novos pacotes e ferramentas para resolver problemas da vida real são desenvolvidos diariamente, e recebe críticas e contribuições da comunidade de utilizadores. Como um exemplo, [R-Ladies](https://rladies.org/) é uma organização mundial cuja missão é promover a diversidade de género na comunidade R, e é uma das maiores organizações de utilizadores de R. É provável que tenha uma divisão perto de você!

Traduzido com a versão gratuita do tradutor - www.DeepL.com/Translator

## Termos chave

**RStudio** -RStudio é uma Interface Gráfica de Utilizador (GUI) para uma utilização mais fácil da linguagem  **R***. Leia mais [na secção RStudio](#rstudio).

**Objetos** - Tudo o que se armazena em R - conjuntos de dados, variáveis, uma lista de nomes de cidades, um número total da população, mesmo saídas como gráficos - são *objetos* aos quais é *atribuído um nome* e *podem ser referenciados* em comandos posteriores. Ler mais [na secção Objectos](#objetos).

**Funções** - Uma função é uma operação de código que aceita entradas e devolve uma saída transformada. Leia mais [na secção Funções](#funções).

**Pacotes** - Um pacote R é um pacote partilhável de funções. Leia mais [na secção Pacotes](#packages)

**Scripts/Códigos** - Um script é um arquivo que contém as linhas de comando que escreveu. Leia mais [na secção Scripts](#scripts)

## Recursos para a aprendizagem {#learning}

### Recursos dentro do RStudio {.unnumbered}

**Documentação de ajuda**

Pesquisar na aba"Ajuda" do RStudio pela documentação sobre pacotes do R e funções específicas. Isto está dentro do painel que também contém "Arquivos", "Gráficos" e "Pacotes" (tipicamente no painel inferior direito). Como atalho, também se pode digitar o nome de um pacote ou função no console do R após um ponto de interrogação para abrir a página de Ajuda relevante. Não inclui parênteses.

Por exemplo: `?filter` ou `?diagrammeR`.

**Tutoriais interativos**

Há várias maneiras de aprender R interactivamente *dentro* do RStudio.

O próprio RStudio oferece um painel Tutorial que é alimentado pelo pacote do R [**learnr**](https://blog.rstudio.com/2020/02/25/rstudio-1-3-integrated-tutorials/). Basta instalar este pacote e abrir um tutorial através da nova aba "Tutorial" no painel superior direito do RStudio (que também contém os separadores Ambiente e Histórico).

O pacote do R [**swirl**](https://swirlstats.com/) oferece cursos interativos no Console do R. Instale e carregue este pacote, depois execute o comando `swirl()` (parênteses vazios) no Console do R. Você verá avisos aparecerem no Console. Responda digitando no Console. Ele irá guiá-lo através de um curso à sua escolha.

### Página de dicas {.unnumbered}

Há várias "cheatsheets" em pdf disponíveis no [website do RStudio](https://rstudio.com/resources/cheatsheets/), por exemplo:

-   Fatores com o pacote **forcats**
-   Datas e horas com o pacote **lubridate**
-   Caracteres com o pacote **stringr**
-   Operações iterativas com o pacote **purrr**
-   Importação de dados
-   Folha de dica para transformação de dadas com o pacote **dplyr**
-   R Markdown (para criar documentos como PDF, Word, Powerpoint...)
-   Shiny (para construir aplicativos de web interativos)
-   Visualização de dados com o pacote **ggplot2**
-   Cartografia (GIS)
-   Pacote **leaflet** (mapas interativos)
-   Python com R (pacote **reticulate**)

Este é um recurso online do R especificamente para [usuários do Excel](https://jules32.github.io/r-for-excel-users/)

### Twitter {.unnumbered}

R tem uma vibrante comunidade no twitter onde você pode aprender dicas, atalhos e notícias, siga estas contas:

-   Siga nos! [\@epiRhandbook](https://twitter.com/epirhandbook)
-   R Function A Day [\@rfuntionaday](https://twitter.com/rfunctionaday) é um recurso *incrível*
-   R for Data Science [\@rstats4ds](https://twitter.com/rstats4ds?lang=en)
-   RStudio [\@RStudio](https://twitter.com/rstudio?lang=en)
-   RStudio Tips [\@rstudiotips](https://twitter.com/rstudiotips)
-   R-Bloggers [\@Rbloggers](https://twitter.com/Rbloggers)
-   R-ladies [\@RLadiesGlobal](https://twitter.com/RLadiesGlobal)
-   Hadley Wickham [\@hadleywickham](https://twitter.com/hadleywickham?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor)

Também:

**\#epitwitter** e **\#rstats**

### Recursos online gratuitos {.unnumbered}

Um texto definitivo é o livro [R for Data Science](https://r4ds.had.co.nz/) de Garrett Grolemund e Hadley Wickham

O site do projeto [R4Epis](https://r4epis.netlify.app/) tem como objetivo “desenvolver ferramentas padronizadas de limpeza, análise e relatório de dados para cobrir tipos comuns de surtos e pesquisas populacionais que seriam conduzidas em um ambiente de resposta a emergências de MSF”. Você pode encontrar materiais de treinamento básicos do R, modelos para relatórios do RMarkdown sobre surtos e pesquisas e tutoriais para ajudá-lo a configurá-los.

### Idiomas além do inglês {.unnumbered}

[Materiais do RStudio em Espanhol](https://www.rstudio.com/collections/espanol/)

[Introdução ao R e ao tidyverse (Francês)](https://juba.github.io/tidyverse/index.html)

<!-- ======================================================= -->

## Instalação

### R e R Studio {.unnumbered}

**Como instalar o R**

Visite o site <https://www.r-project.org/> e faça o *download*da versão mais recente do  R que seja adequada para o seu computador.

**Como instalar o RStudio**

Visite esse website <https://rstudio.com/products/rstudio/download/> e faça o *download* da versão gratuita mais recente para Desktop do RStudio que seja adequada para seu computador.

**Permissões**
Note que você deve instalar R e RStudio em um drive onde você tenha permissões de leitura e escrita. Caso contrário, sua capacidade de instalar pacotes R (um problema de ocorrência freqüente) será impactada. Se você encontrar problemas, tente abrir o RStudio clicando com o botão direito do mouse no ícone e selecionando "Executar como administrador". Outras dicas podem ser encontradas na página [R em unidades de rede].


**Como atualizar o R e o RStudio**

Sua versão de R é impressa no o Console R na inicialização. Você também pode executar o `sessionInfo()`.

Para atualizar o R, vá para o site mencionado acima e reinstale o R. Alternativamente, você pode utilizar o pacote **installr** (no Windows) executando `installr::updateR()`. Isto abrirá caixas de diálogo para ajudá-lo a baixar a última versão R e atualizar seus pacotes para a nova versão R. Mais detalhes podem ser encontrados na **installr** [documentação](https://www.r-project.org/nosvn/pandoc/installr.html).

Esteja ciente de que a antiga versão R ainda existirá em seu computador. Você pode executar temporariamente uma versão antiga (antiga "instalação") do R clicando em "Ferramentas" -> "Opções Globais" no RStudio e escolhendo uma versão R. Isto pode ser útil se você quiser usar um pacote que não tenha sido atualizado para funcionar na versão mais nova do R.

Para atualizar o RStudio, você pode ir ao site acima e fazer o download novamente do RStudio. Outra opção é clicar em "Ajuda" -\> "Verificar Atualizações" dentro do RStudio, mas isto pode não mostrar as últimas atualizações.

Para ver quais versões do R, RStudio, ou pacotes foram usados quando este Manual foi feito, veja a página em [Notas editoriais e técnicas].


### Outros softwares você *pode* precisar instalar {.unnumbered}

-   TinyTeX (*para compilaar documentos de RMarkdown em PDF*)
-   Pandoc (*para compilar documentos de RMarkdown*)
-   RTools (*para construir pacotes em R*)
-   phantomjs (*para salvar imagens ou redes animadas, como redes de transmissão*)

#### TinyTex {.unnumbered}

TinyTex é uma distribuição do LaTeX customizada, útil quando for tentar produzir PDFs no R.
Veja <https://yihui.org/tinytex/> para mais informações.

Para instalar o TiniTex no R:

```{r, eval=F}
install.packages('tinytex')
tinytex::install_tinytex()
# para desisntalar o TinyTeX, corra tinytex::uninstall_tinytex()
```

#### Pandoc {.unnumbered}

Sua versão de R é impressa no o Console R na inicialização. Você também pode executar o Pandoc é um conversor de documentos, um software separado do R. ** Ele vem junto com o RStudio e não deve precisar ser baixado.** Ele ajuda no processo de conversão de documentos Rmarkdown para formatos como .pdf e adição de funcionalidades complexas.

#### RTools {.unnumbered}

RTools é uma coleção de softwares para construção de pacotes para R

Instale desse website: <https://cran.r-project.org/bin/windows/Rtools/>

#### phantomjs {.unnumbered}

Esta ferramenta é freqüentemente usada para tirar "fotografias da tela" de páginas da web. Por exemplo, quando você cria uma cadeia de transmissão com o pacote **epicontacts**,  um arquivo HTML é produzido e ele é interativo e dinâmico. Se você quiser uma imagem estática, pode ser útil usar o pacote [**webshot**](https://wch.github.io/webshot/articles/intro.html) para automatizar este processo. Isto exigirá o programa externo "phantomjs". Você pode instalar o phantomjs através do pacote **webshot** com o comando `webshot::install_phantomjs()`.

<!-- ======================================================= -->

## RStudio {#rstudio}

### Se orientando no RStudio  {.unnumbered}

**Primeiramente, abra o RStudio.** Como os ícones deles podem ser muito parecidos, certifique-se de que você está abrindo *RStudio* e não R.

Para que o RStudio funcione, você também deve ter R instalado no computador (veja acima as instruções de instalação).

**RStudio** é uma interface (GUI) para facilitar o uso de **R**. Você pode pensar em R como sendo o motor de um veículo, fazendo o trabalho crucial, e RStudio como a carroceria do veículo (com assentos, acessórios, etc.) que ajuda você realmente a usar o motor para seguir em frente! Você pode ver a ficha completa da interface de usuário do RStudio (PDF) [aqui](https://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf)

Por padrão, o RStudio exibe quatro painéis retangulares.

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "RStudio_overview.png"))
```

[***DICA:*** Se o seu RStudio mostrar apenas um painel esquerdo, é porque não há nenhum script aberto ainda]{style="color: black;"}

**O Painel Fonte**
Este painel, por padrão localizado na parte superior esquerda, é um espaço onde é possível editar, executar e salvar seus [scripts](#scripts). Os scripts contêm os comandos que você deseja executar. Este painel também pode exibir conjuntos de dados (quadros de dados) para visualização.

Para usuários da Stata, este painel é similar às janelas de seu Do-file e Data Editor.

**O Painel de Console R**

O Console R, ou simplesmente Console, é por padrão o painel esquerdo ou inferior esquerdo do RStudio. Ele é a casa do "motor" R. É aqui que os comandos são realmente executados e as saídas não gráficas e as mensagens de erro/aviso aparecem. Você pode digitar e executar comandos diretamente no Console, mas perceba que estes comandos não são salvos como são ao executar comandos de um script.

Se você está familiarizado com Stata, o Console R é como a Janela de Comando e também a Janela de Resultados.

**O Painel Ambiente**

Este painel, por padrão na parte superior direita, é mais freqüentemente usado para ver resumos breves de [objetos] (#objetos) no Ambiente R na sessão atual. Estes objetos podem incluir conjuntos de dados importados, modificados ou criados, parâmetros que você definiu (por exemplo, uma semana epidemiológica específica para a análise), ou vetores ou listas que você definiu durante a análise (por exemplo, nomes de regiões). Você pode clicar na seta ao lado de um nome de data frame para ver suas variáveis.

No Stata, isto é mais parecido com a janela Gerenciador de Variáveis.

Este painel também contém a aba *History* onde você pode ver comandos que você pode ver anteriormente. Tem também uma aba "Tutorial" onde você pode completar tutoriais R interativos se você tiver o pacote **learnr** instalado. Tem também um painel "Conections" para conexões externas, e pode ter um painel "Git" se você optar por fazer interface com o Github.

**Paineis Plots (Gráficos), Viewer, Packages (Pacotes), e Help (Ajuda)**

O painel inferior-direito inclui várias abas importantes. Gráficos típicos, incluindo mapas, serão exibidos no painel Plo. Saídas interativas ou HTML serão exibidas no painel do Visualizador (Viewer). O painel de Ajuda (Help) pode exibir documentação e arquivos de ajuda. O painel Arquivos (Files) é um navegador que pode ser usado para abrir ou excluir arquivos. O painel Pacotes (Packages) permite ver, instalar, atualizar, excluir, carregar/descarregar pacotes R, e ver qual versão do pacote você tem. Para saber mais sobre pacotes, veja a [seção pacotes](#packages) abaixo.

Este painel contém os equivalentes Stata das janelas Plots Manager e Project Manager.

### Configurações do RStudio  {.unnumbered}

Altere as configurações e a aparência do RStudio no menu suspenso *Ferramentas* (Tools), selecionando *Opções Globais* (Global Options). Lá você pode alterar as configurações padrão, incluindo a cor da aparência/fundo.

```{r out.width = c('50%'), fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "RStudio_tools_options_1.png"))

knitr::include_graphics(here::here("images", "RStudio_tools_options.png"))
```

**Restart (Reiniciar)**

Se seu R travar, você pode reiniciar o R indo ao menu Sessão (Session) e clicando em "Reiniciar R" (Restart R). Isto evita o incômodo de fechar e abrir o RStudio. Tudo em seu ambiente R será removido quando você fizer isso.

### Atalhos no teclado {.unnumbered}

Alguns atalhos de teclado muito úteis estão abaixo. Veja todos os atalhos de teclado para Windows, Mac e Linux na segunda página deste RStudio [cheatsheet da interface do usuário](https://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf).

+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Windows/Linux                    | Mac                    | Ação                                                                                                                         |
+==================================+========================+================================================================================================================================+
| Esc                              | Esc                    | Interrompe comando atual (útil se você acidentalmente executou um comando incompleto e não pode escapar de ver o "+" no console R)|
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl+s                           | Cmd+s                  | Salva (script)                                                                                                                 |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Tab                              | Tab                    | Auto-completa                                                                                                                  |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Enter                     | Cmd + Enter            | Roda a(s) linha(s) atual(is)/seleção de código   |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + C                 | Cmd + Shift + c        | comenta/descomenta as linhas selecionadas                                                                                       |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Alt + -                          | Option + -             | Insere `<-`                                                                                                                    |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + m                 | Cmd + Shift + m        | Insere `%>%`                                                                                                                   |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + l                         | Cmd + l                | Limpa o console                                                                                                                |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + b                   | Cmd + Option + b       | Roda do início até a linha atual                                                                                              |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + t                   | Cmd + Option + t       | Roda a seção de código atual (R Markdown)                                                                                      |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + i                   | Cmd + Shift + r        | Insere chunk de código (no R Markdown)                                                                                            |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + c                   | Cmd + Option + c       | Roda o chunk atual (R Markdown)                                                                                            |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| up/down arrows in R console      | Same                   | Alterna entre os comandos executados recentemente                                                                                          |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Shift + up/down arrows in script | Same                   | Seleciona múltiplas linhas de código                                                                                                   |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + f                         | Cmd + f                | Procura e substitui no script atual                                                                                            |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + f                 | Cmd + Shift + f        | Encontra em arquivos (pesquisa/substitui em vários script)                                                                             |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Alt + l                          | Cmd + Option + l       | Oculta código atual                                                                                                             |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Shift + Alt + l                  | Cmd + Shift + Option+l | Exibe código sele                                                                                                           |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+

[***DICA:*** Use sua tecla Tab ao digitar para ativar a funcionalidade de auto-completar do RStudio. Isto pode evitar erros ortográficos. Pressione Tab enquanto digita para produzir um menu suspenso de funções e objetos prováveis, com base no que você digitou até agora. ]{style="color: darkgreen;"}

<!-- ======================================================= -->

## Funções {#functions}

As funções estão no cerne do uso de R. As funções são a forma como você executa tarefas e operações. Muitas funções vêm instaladas com R, muitas mais estão disponíveis para download em *packages* (explicado na seção [pacotes](#packages)), e você pode até mesmo escrever suas próprias funções personalizadas!

Esta seção básica sobre funções explica:

-   O que é uma função e como funcionam
-   O que são os *argumentos/parâmetros* de uma função
-   Como conseguir ajuda para compreender uma função

*Uma nota rápida sobre a sintaxe:* Neste manual, as funções são escritas em texto de código com parênteses abertos, como este: `filter()`. Como explicado na seção [pacotes](#packages), as funções são baixadas dentro de *pacotes*. Neste manual, os nomes dos pacotes são escritos em **negrito**, como **dplyr**. Às vezes, no código de exemplo, você pode ver o nome da função ligado explicitamente ao nome de seu pacote com um par de dois-pontos (`::`) como este: `dplyr::filter()`. O propósito desta ligação é explicado na seção de pacotes.

<!-- ======================================================= -->

### Funções simples {.unnumbered}

**Uma função é como uma máquina que recebe entradas, faz alguma ação com essas entradas e produz uma saída.** O que é a saída depende da função.

**Funções normalmente operam sobre algum objeto colocado dentro dos parênteses da função**. Por exemplo, a função `sqrt()` calcula a raiz quadrada de um número:

```{r basics_function_sqrt}
sqrt(49)
```

O objeto fornecido a uma função também pode ser uma coluna em um conjunto de dados (veja a seção [Objetos](#objetos) para detalhes sobre todos os tipos de objetos). Como R pode armazenar vários conjuntos de dados, será necessário especificar tanto o conjunto de dados quanto a coluna. Uma maneira de fazer isso é utilizar a notação `$` para ligar o nome do conjunto de dados e o nome da coluna (`dataset$coluna`). No exemplo abaixo, a função `summary()` é aplicada à coluna numérica `age` (idade) no conjunto de dados `linelist`, e a saída é um resumo dos valores numéricos e valores ausentes da coluna.

```{r basics_functions_summary}
#Imprimir estatísticas resumidas da coluna 'age' (idade) no conjunto de dados 'linelist'.
summary(linelist$age)
```

[***NOTA:*** Nos bastidores, uma função representa um código adicional complexo que foi condensado para o usuário em um comando fácil.]{style="color: black;"}

<!-- ======================================================= -->

### Funções com argumentos múltiplos {.unnumbered}

As funções frequentemente pedem várias entradas, chamadas ***argumentos***, ou **parâmetros**, localizadas dentro dos parênteses da função, geralmente separadas por vírgulas.

- Alguns argumentos são necessários para que a função funcione corretamente, outros são opcionais
- Argumentos opcionais têm configurações padrão
- Os argumentos podem ter caráter, numérico, lógico (TRUE/FALSE)(*verdadeiro/falso*), e outros inputs

Aqui está uma função ficcional divertida, chamada `oven_bake()` ( do inglês: assar no forno), como um exemplo de uma função típica. Ela pega um objeto de entrada (por exemplo, um conjunto de dados, ou neste exemplo "dough" - massa) e realiza operações sobre ele como especificado por argumentos adicionais (`minutes =` e `temperature =`). A saída pode ser impressa para o console, ou salva como um objeto utilizando o operador de atribuição `<-`.

```{r basics_functions_image, echo=F, out.width = "75%", fig.align = "center"}
knitr::include_graphics(here::here("images", "Function_Bread_Example.png"))
```

**Em um exemplo mais realístico**, o comando `age_pyramid()` abaixo produz uma pirâmide etária baseado em faixas-etárias e uma coluna divisória binária, como `gender` (gênero). A função recebe três argumentos dentro dos parênteses, separados por vírgulas. Os valores fornecidos aos argumentos estabelecem `linelist` como o quadro de dados a utilizar, `age_cat5` como a coluna a contar, e `gender` como a coluna binária a utilizar para dividir a pirâmide por cor.

```{r basics_functions_arguments, include=FALSE, results='hide', message=FALSE, warning=FALSE,}
## crie uma variável de faixa-etária especificando classes categóricas 
linelist$age_group <- cut(linelist$age, breaks = c(0, 5, 10, 15, 20, 30, 45, 60))
```

```{r message=FALSE, warning=FALSE,  out.width = "75%", out.height="75%"}
# Crie uma pirâmide etária
age_pyramid(data = linelist, age_group = "age_cat5", split_by = "gender")
```

O comando acima pode ser escrito de forma equivalente ao abaixo, em um estilo mais longo com uma nova linha para cada argumento. Este estilo pode ser mais fácil de ler, e mais fácil de escrever "comentários" com `#` para explicar cada parte (comentar extensivamente é uma boa prática!). Para executar este comando mais longo, você pode destacar todo o comando e clicar em "Run", ou simplesmente colocar o cursor na primeira linha e, em seguida, pressionar simultaneamente as teclas Ctrl e Enter.

```{r message=FALSE, warning=FALSE,  out.width = "75%", out.height="75%"}
# Crie uma pirâmide etária
age_pyramid(
  data = linelist,        # Use a linelist de casos
  age_group = "age_cat5", # disponibilize a coluna de faixa-etária
  split_by = "gender"     #usee a coluna de gênero para criar dois lados da pirâmide 
  )
```

A primeira metade de uma atribuição de argumentos (por exemplo, `dados =`) não precisa ser especificada se os argumentos forem escritos em uma ordem específica (especificada na documentação da função). O código abaixo produz exatamente a mesma pirâmide que o acima, porque a função espera a ordem dos argumentos: quadro de dados, variável `age_group`, variável `split_by`.

```{r, basics_functions_pyramid2, eval = FALSE, warning=FALSE, message=FALSE, , out.width = "75%", out.height="75%", eval=F}
# Esse comando retorna o mesmo gráfico gerado acima
age_pyramid(linelist, "age_cat5", "gender")
```

**Um comando mais complexo de `age_pyramid()` poderia incluir os argumentos *opcionais* para:

- Mostrar proporções em vez de contagens (definir `proportional = TRUE` quando o padrão é `FALSE`)
- Especifique as duas cores a serem utilizadas (`pal =` é a abreviação de "paleta" e é fornecido com um vetor de dois nomes de cores. Veja a página [objetos](#objetos) para saber como a função `c()` faz um vetor)

[***NOTA:*** Para argumentos que você especificar com ambas as partes do argumento (por exemplo, `proportional = TRUE`), sua ordem entre todos os argumentos não importa.]{style="color: black;"}

```{r message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"}
age_pyramid(
  linelist,                    # use a linelist de casos
  "age_cat5",                  # coluna de faixa-etária
  "gender",                    # divida por gênero
  proportional = TRUE,         # porcentagem em vez de contagens
  pal = c("orange", "purple")  # cores
  )
```

<!-- ======================================================= -->

### Escrevendo funções {.unnumbered}

R é uma linguagem que é orientada em torno de funções, portanto você deve se sentir capacitado para escrever suas próprias funções. A criação de funções traz várias vantagens:

- Para facilitar a programação modular - a separação do código em peças independentes e gerenciáveis
- Substituir o processo repetitivo de copia e cola, que pode ser propenso a erros.
- Dar nomes memoráveis aos pedaços de código

Como escrever uma função é abordado em profundidade na página [Funções de escrita].

<!-- A function is given a name and defined with the assignment operator `<-` to a special **base** R function called `function()`. Within the parentheses, the arguments that the function will accept are defined. This is followed by curly brackets `{ }`, within which the actual code of the function is written.     -->

```{r, eval=F, echo=F}
my_function <- function( ARGUMENTS HERE ){ CODE HERE }
```

<!-- The arguments should be provided in the syntax `argument = default`, separated by commas.   -->

<!-- Here is an example where we create a function `staff_calc()` to serve as a staffing calculator for COVID-19 case investigation and contact tracing calls.   -->

<!-- The arguments (inputs) and their default values will be:   -->

<!-- * `daily_cases = NULL` The number of new COVID-19 cases per day   -->

<!-- * `contacts_each = 5` The number contacts enumerated for each case   -->

<!-- * `time_case = 0.5`  Number of hours to complete a case investigaton by phone   -->

<!-- * `time_contact = 0.25`  Number of hours to complete a contact follow-up by phone   -->

<!-- * `time_day = 8` The number of hours one staff works per day   -->

<!-- Below, the function is created. The code ends with the special function `return()`, which is what the function produces.    -->

<!-- ```{r message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"} -->

<!-- staff_calc <- function(daily_cases = NULL, contacts_each = 5, -->

<!--                        time_case = 0.5, time_contact = 0.25, time_day = 8){ -->

<!--   # Define total daily hours for calling cases -->

<!--   case_hours <- daily_cases * time_case  -->

<!--   # Define total daily hours for calling contacts -->

<!--   contact_hours <- daily_cases * contacts_each * time_contact -->

<!--   # Calculate number of staff required -->

<!--   staff_required <- (case_hours + contact_hours)/time_day -->

<!--   return(staff_required) -->

<!-- } -->

<!-- ``` -->

<!-- Once this code is run, the function will be defined and will appear in the R Environment. We can run the function. Below all the default values are used and the `daily_cases = ` is set to 150.   -->

```{r eval=F, echo=F, message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"}
staff_calc(daily_cases = 150)
```

```{r, eval=F, echo=F}
case_incidence <- tibble(
  dates = seq.Date(from = as.Date("2020-05-01"), to = as.Date("2020-05-21"), by = 1),
  projected_incidence = c(102,110,50,37,106,190,146,138,135,111,60,43,189,184,185,80,44,97,254,291,288),
  staff_needed = staff_calc(projected_incidence)
)

ggplot(case_incidence, aes(x = dates))+
  geom_line(aes(y = projected_incidence))+
  geom_line(aes(y = staff_needed))
```

<!-- There are many other nuances to understand when writing functions, as discussed in the page [Writing functions].   -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Pacotes {#packages}

**Pacotes contém funções.**

Um pacote R é um pacote compartilhável de código e documentação que contém funções pré-definidas. Os usuários da comunidade R desenvolvem pacotes o tempo todo, atendendo a problemas específicos, e é provável que alguém possa ajudar com seu trabalho inclusive! Você com certeza irá instalar e usar centenas de pacotes em seu uso de R.

Na instalação, o R contém pacotes de  **"base"**  e funções que executam tarefas elementares e comuns. Mas muitos usuários do R criam funções especializadas, que são verificadas pela comunidade R e que você pode baixar como um  **package** (pacote) para seu próprio uso. Neste manual, os nomes dos pacotes estão escritos em **negrito***. Um dos aspectos mais desafiadores do R é que muitas vezes há muitas funções ou pacotes a serem escolhidos para complementar uma determinada tarefa.


### Instalar e carregar{.unnumbered}

*As funções* estão contidas nos **pacotes** que podem ser baixados ("instalados") para seu computador a partir da Internet. Uma vez que um pacote é baixado, ele é armazenado em sua "biblioteca" (do inglês, *library*). Você pode então acessar as funções que ele contém durante sua sessão R atual "carregando" este pacote.

*Pense em R como sua biblioteca pessoal*: Quando você baixa um pacote, sua biblioteca ganha um novo livro de funções, mas cada vez que você quiser usar uma função naquele livro, você deve pegar emprestado ("carregar") aquele livro de sua biblioteca.

Em resumo: para usar as funções disponíveis em um pacote R, duas etapas devem ser implementadas:

1)  O pacote precisa ser **instalado** (uma vez), *e*  

2)  O pacote precisa ser **carregado** (a cada sessão de R que abrir)

####Sua biblioteca {.unnumbered}

Sua "biblioteca" é na verdade uma pasta em seu computador, contendo uma subpasta para cada pacote que foi instalado. Descubra onde R está instalado em seu computador, e procure uma pasta chamada "win-library". Por exemplo: `R\win-library\4.0` (a 4.0 é a versão R - você terá uma biblioteca diferente para cada versão R que você baixou).

Você pode exibir ("printar") o caminho do arquivo para sua biblioteca digitando `.libPaths()` (parênteses vazios). Isto se torna especialmente importante se você trabalhar com [R em unidades de rede].


#### Instalar do CRAN {.unnumbered}

Na maioria das vezes, os usuários R baixam pacotes da CRAN. CRAN (Comprehensive R Archive Network) é um repositório público on-line de pacotes R que foram publicados por membros da comunidade R.

Você está preocupado com vírus e segurança ao fazer o download de um pacote da CRAN? Leia [este artigo](https://support.rstudio.com/hc/en-us/articles/360042593974-R-and-R-Package-Security) sobre o assunto.


#### Como instalar e carregar {.unnumbered}

Neste manual, sugerimos o uso do pacote **pacman** (abreviação para "package manager" que significa "gerenciador de pacotes" em inglês). Ele oferece uma função conveniente `p_load()` que instalará um pacote se necessário *e* o carregará para utilização na sessão R atual.

A sintaxe é bastante simples. Basta listar os nomes dos pacotes dentro dos parênteses `p_load()`, separados por vírgulas. Este comando instalará os pacotes **rio**, **tidyverse**, e **here** se ainda não estiverem instalados, e os carregará para utilização. Isto torna a abordagem `p_load()` conveniente e concisa se compartilhar scripts com outros. Observe que os nomes dos pacotes são sensíveis a maiúsculas e minúsculas.


```{r}
# Instala (se necessário) e os carrega para o uso
pacman::p_load(rio, tidyverse, here)
```

Note que utilizamos a sintaxe `pacman::p_load()` que escreve explicitamente o nome do pacote (**pacman**) antes do nome da função (`p_load()`), conectado por duas colunas `::`. Esta sintaxe é útil porque também carrega o pacote **pacman** (assumindo que já esteja instalado).

Existem funções alternativas do R **base** que você verá com freqüência. A função do R **base**  para instalar um pacote é `install.packages()`. O nome do pacote a ser instalado deve ser fornecido entre parênteses *em aspas*. Se você quiser instalar vários pacotes em um comando, eles devem ser listados dentro de um vetor de caracteres `c()`.

Nota: este comando *instala* um pacote, mas *não* o carrega para utilização na sessão atual.

```{r, eval=F}
# essa função disponível no R base instala um único pacote 
install.packages("tidyverse")

# install multiple packages with base R
install.packages(c("tidyverse", "rio", "here"))
```

A instalação também pode ser feita clicando e apontando para o painel "Pacotes" do RStudio e clicando em "Instalar" e procurando pelo nome do pacote desejado.

A função do R **base** para **carregar** um pacote para utilização (após ter sido instalado) é `library()`. Ela pode carregar apenas um pacote de cada vez (outro motivo para utilizar `p_load()`). Você pode fornecer o nome do pacote com ou sem aspas.

```{r, eval=F}
# com o R base, você pode carregar os pacotes dessa forma 
library(tidyverse)
library(rio)
library(here)
```

Para verificar se um pacote está instalado e/ou carregado, você pode visualizar o painel de Pacotes no RStudio. Se o pacote estiver instalado, ele é mostrado lá com o número da versão. Se sua caixa for marcada, ela é carregada para a sessão atual.

**Instalar a partir do Github**.

Às vezes, você precisa instalar um pacote que ainda não está disponível na CRAN. Ou talvez o pacote esteja disponível na CRAN, mas você quer a versão *em desenvolvimento* com novos recursos ainda não oferecidos na versão publicada mais estável da CRAN. Estes são frequentemente hospedados no site [github.com](https://github.com/) em um "repositório" de código gratuito e voltado para o público. Leia mais sobre Github na página do manual [Controle de versão e colaboração com Git e Github].

Para baixar os pacotes R do Github, você pode utilizar a função `p_load_gh()` do **pacman**, que instalará o pacote se necessário, e o carregará para utilização em sua sessão R atual. As alternativas para instalar incluem a utilização dos pacotes **remotes** ou **devtools**. Leia mais sobre todas as funções **pacman** na [documentação do pacote](https://cran.r-project.org/web/packages/pacman/pacman.pdf).

Para instalar a partir do Github, você precisa fornecer mais informações. Você tem que fornecer:

1) A identificação do proprietário do repositório Github  

2) O nome do repositório que contém o pacote  

3)  *(opcional) O nome do "ramo" (o "branch" da versão de desenvolvimento específico) que você deseja baixar*  

Nos exemplos abaixo, a primeira palavra entre aspas representa a ID do Github do proprietário do repositório, após a barra é o nome do repositório (o nome do pacote).  

```{r, eval=F}
# instala/carrega o pacote epicontacts do seu repositório Github 
p_load_gh("reconhub/epicontacts")
```

Se você quiser instalar de um "branch" (versão) diferente da principal, adicione o nome do "branch" após um "\@", após o nome do repositório.

```{r, eval=F}
# instale o "branch"(ramo) "timeline" do pacte epicontacts do Github
p_load_gh("reconhub/epicontacts@timeline")
```

Se não houver diferença entre a versão do Github e a versão em seu computador, nenhuma ação será tomada. Você pode "forçar" uma reinstalação utilizando `p_load_current_gh()` com o argumento `update = TRUE`. Leia mais sobre **pacman*** nesta [vinheta online](http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html)

**Instale a partir de ZIP ou TAR**

Você poderia instalar um pacote de um endereço URL:

```{r, eval=F}
packageurl <- "https://cran.r-project.org/src/contrib/Archive/dsr/dsr_0.2.2.tar.gz"
install.packages(packageurl, repos=NULL, type="source")
```

Ou, faça o download dele para seu computador em um arquivo comprimido ("zipado"):

Opção 1: usando`install_local()` do pacote **remotes** 

```{r, eval=F}
remotes::install_local("~/Downloads/dplyr-master.zip")
```

Opção 2: usando `install.packages()` do R **base**, fornecendo o caminho do arquivo comprimido e configurando os parâmetros `type = "source` e `repos = NULL`.

```{r, eval=F}
install.packages("~/Downloads/dplyr-master.zip", repos=NULL, type="source")
```

### Sintaxe do código {.unnumbered}

For clarity in this handbook, functions are sometimes preceded by the name of their package using the `::` symbol in the following way: `package_name::function_name()`

Once a package is loaded for a session, this explicit style is not necessary. One can just use `function_name()`. However writing the package name is useful when a function name is common and may exist in multiple packages (e.g. `plot()`). Writing the package name will also load the package if it is not already loaded.

```{r eval=FALSE}
# Este comando usa o pacote "rio" e sua função   "import()" para importar uma base de dados.
linelist <- rio::import("linelist.xlsx", which = "Sheet1")
```

### Auxílio para as funções {.unnumbered}

Para maior clareza neste manual, as funções são algumas vezes precedidas pelo nome de seu pacote utilizando o símbolo `::` da seguinte forma: `nome_do_pacote::nome_da_função()`

Uma vez carregado um pacote para uma sessão, este estilo explícito não é mais necessário. Pode-se simplesmente utilizar `nome_da_função()`. Entretanto, escrever o nome do pacote é útil quando um nome de função é muito comum e pode existir em vários pacotes (por exemplo, `plot()`). Escrever o nome do pacote também irá carregar o pacote se ele ainda não estiver carregado.

### Atualizando pacotes {.unnumbered}

Você pode atualizar os pacotes, reinstalando-os. Você também pode clicar no botão verde "Atualizar" em seu painel de Pacotes RStudio para ver quais pacotes têm novas versões para instalar. Esteja ciente de que seu código antigo pode precisar ser atualizado se houver uma grande revisão de como uma função funciona!

### Apagar pacotes {.não numerados}

Utilize `p_delete()` de **pacman**, ou `remove.packages()` do R **base**. Alternativamente, procure a pasta que contém sua biblioteca e exclua manualmente a pasta.

### Dependências {.não numeradas}

Os pacotes muitas vezes dependem de outros pacotes para funcionar. Estes são chamados de dependências. Se uma dependência falhar na instalação, então o pacote dependendo dela também pode falhar na instalação.

Veja as dependências de um pacote com `p_depends()`, e veja quais pacotes dependem dele com `p_depends_reverse()`.

### Funções mascaradas {.não numeradas}

Não é raro que dois ou mais pacotes contenham o mesmo nome de função. Por exemplo, o pacote **dplyr** tem uma função `filter()`, mas o pacote **stats** também. A função padrão `filter()` depende da ordem em que estes pacotes são carregados primeiro na sessão R - a última será o padrão para o comando `filter()`.

Você pode verificar a ordem em seu painel Environment (Ambiente) do R Studio - clique no menu suspenso para Global Environment ("Ambiente Global") e veja a ordem dos pacotes. Funções de pacotes *mais abaixo* nessa lista suspensa mascararão funções com o mesmo nome em pacotes que aparecem mais altos na lista suspensa. Ao carregar um pacote pela primeira vez, R avisará no console se estiver ocorrendo mascaramento, mas isto pode ser fácil de perder.  

```{r out.width = "50%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "masking_functions.png"))
```

1) Especifique o nome do pacote no comando. Por exemplo, utilize `dplyr::filter()` 
2) Reorganize a ordem na qual os pacotes são carregados (por exemplo, dentro de `p_load()`), e **inicie uma nova sessão R*.

### Desprender / descarregar {.sem numeração}

Para separar (descarregar) um pacote, use este comando, com o nome correto do pacote e apenas um "dois pontos". Note que isto pode não resolver o mascaramento.


```{r, eval=F}
detach(package:PACKAGE_NAME_HERE, unload=TRUE)
```

### Instalar uma versão mais antiga {.unnumbered}

Veja este [guia](https://support.rstudio.com/hc/en-us/articles/219949047-Installing-older-versions-of-packages) para instalar uma versão mais antiga de um pacote em particular.

### Pacotes sugeridos{.unnumbered}

Veja a página em [Pacotes sugeridos] para uma listagem de pacotes que recomendamos para o dia-a-dia em epidemiologia.

<!-- ======================================================= -->

## Scripts {#scripts}

Os scripts (que significa "roteiro" em inglês) são uma parte fundamental da programação. Eles são documentos que contêm seus comandos (por exemplo, funções para criar e modificar conjuntos de dados, visualizações de impressão, etc.). Você pode salvar um script e executá-lo novamente mais tarde. Há muitas vantagens em armazenar e executar seus comandos a partir de um script (versus digitar comandos um a um na "linha de comando" do console R):

- Portabilidade - você pode compartilhar seu trabalho com outros enviando-lhes seus scripts\
- Reprodutibilidade - para que você e outros saibam exatamente o que você fez
- Controle de versão - para que você possa acompanhar as mudanças feitas por você ou colegas\
- Comentando/anotando - para explicar a seus colegas o que você tem feito

### Comentando {.sem numeração}

Em um script você também pode anotar ("fazer comentários") ao longo do seu código R. Comentar é útil para explicar a si mesmo e aos outros leitores o que você está fazendo. Você pode adicionar um comentário digitando o símbolo "hashtag" (\#) e escrevendo seu comentário depois dele. O texto comentado aparecerá em uma cor diferente da do código R.

Qualquer código escrito após o \# não será executado. Portanto, colocar um \# antes do código também é uma maneira útil de bloquear temporariamente uma linha de código ("comentar fora") se você não quiser apagá-lo). Você pode fazer isso em várias linhas ao mesmo tempo, selecionando-as e pressionando Ctrl+Shift+c (Cmd+Shift+c no Mac).

```{r, eval = F}
# Um comentário pode ser uma linha por si só
# importar dados
linelist <- import("linelist_raw.xlsx") %>%   # também pode ser após o código
# filter(age > 50)                          # também pode ser usado para desativar uma linha de código
  count()

```

- Comente sobre *o que* você está fazendo e sobre **por que** você está fazendo.
- Divida seu código em seções lógicas...
- Acompanhe seu código com uma descrição passo a passo em texto do que você está fazendo (por exemplo, passos numerados)

### Estilo {.sem numeração}

É importante estar consciente de seu estilo de codificação - especialmente se estiver trabalhando em equipe. Defendemos o uso do **tidyverse** [guia de estilo](https://style.tidyverse.org/). Há também pacotes como **styler** e **lintr** que o ajudam a se adequar a este estilo.

Alguns pontos muito básicos para tornar seu código legível para outros:

\* Ao nomear objetos, utilize apenas letras minúsculas, números e sublinhados `_`, por exemplo `my_data`.
\* Utilize espaços frequentes, inclusive ao redor dos operadores, por exemplo `n = 1` e `age_new <- age_old + 3`

### Exemplo de Script {.sem numeração}

Abaixo está um exemplo de um pequeno script R. Lembre-se, quanto melhor você explicar sucintamente seu código nos comentários, mais seus colegas vão gostar de você!

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "example_script.png"))
```

<!-- ======================================================= -->

### R markdown {.unnumbered}

Um script R markdown é um tipo de script R no qual o script em si *resulta* um documento de saída (PDF, Word, HTML, Powerpoint, etc.). Estas são ferramentas incrivelmente úteis e versáteis, freqüentemente usadas para criar relatórios dinâmicos e automatizados. Mesmo este website e manual são produzidos com um script  R markdown!

Vale a pena notar que usuários iniciantes de R também podem usar R Markdown - não se intimidem! Para saber mais, consulte a página do manual nos documentos [Relatórios com R Markdown].

<!-- ======================================================= -->

### Notebooks R {.sem numeração}

Não há diferença entre escrever em um Rmarkdown versus um caderno R. Entretanto, a execução do documento difere ligeiramente. Consulte este [site](http://uc-r.github.io/r_notebook) para obter mais detalhes.

<!-- ======================================================= -->

### Shiny

Os aplicativos/websites shiny estão contidas em um script, que deve ser chamado de `app.R`. Este arquivo tem três componentes:

1) Uma interface de usuário (ui)  
2) Uma função de servidor  
3) Uma chamada para a função `shinyApp'.  

Veja a página do manual em [Dashboards com Shiny], ou este tutorial online: [Tutorial com shiny](https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/)

*Nos tempos mais antigos, o arquivo acima era dividido em dois arquivos (`ui.R` e `server.R`)*

### Código dobrável {.sem numeração}

Você pode colapsar porções de código para facilitar a leitura de seu roteiro.

Para isso, crie um cabeçalho de texto com \##, escreva seu cabeçalho, e siga-o com pelo menos 4 traços (-), hashes (\#) ou igual a (=). Quando você tiver feito isto, uma pequena seta aparecerá na "sarjeta" à esquerda (pelo número da linha). Você pode clicar nesta seta e o código abaixo até o próximo cabeçalho cair e um ícone de seta dupla aparecerá em seu lugar.

Para expandir o código, clique novamente na seta na sarjeta, ou no ícone de duas fileiras. Há também atalhos de teclado como explicado na seção [RStudio](#rstudio) desta página.

Ao criar cabeçalhos com \##, você também ativará o Índice na parte inferior de seu script (veja abaixo) que você pode usar para navegar em seu script. Você pode criar subtítulos adicionando mais símbolos, por exemplo, para primário, para secundário e para terciário.

Abaixo estão duas versões de um script de exemplo. À esquerda está o original com os cabeçalhos comentados. À direita, quatro traços foram escritos após cada cabeçalho, tornando-os colapsáveis. Dois deles foram colapsados, e você pode ver que a Tabela de Conteúdos na parte inferior agora mostra cada seção.

```{r, out.width = c('50%'), fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "code_folding1.png"))
knitr::include_graphics(here::here("images", "code_folding2.png"))
```

Other areas of code that are automatically eligible for folding include "braced" regions with brackets `{ }` such as function definitions or conditional blocks (if else statements). You can read more about code folding at the RStudio [site](https://support.rstudio.com/hc/en-us/articles/200484568-Code-Folding-and-Sections).

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Working directory

The working directory is the root folder location used by R for your work - where R looks for and saves files by default. By default, it will save new files and outputs to this location, and will look for files to import (e.g. datasets) here as well.

The working directory appears in grey text at the top of the RStudio Console pane. You can also print the current working directory by running `getwd()` (leave the parentheses empty).

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "working_directory_1.png"))
```

### Recommended approach {.unnumbered}

**See the page on [R projects] for details on our recommended approach to managing your working directory.**\
A common, efficient, and trouble-free way to manage your working directory and file paths is to combine these 3 elements in an [R project][R projects]-oriented workflow:

1)  An R Project to store all your files (see page on [R projects])\
2)  The **here** package to locate files (see page on [Import and export])\
3)  The **rio** package to import/export files (see page on [Import and export])

<!-- ======================================================= -->

### Set by command {.unnumbered}

Until recently, many people learning R were taught to begin their scripts with a `setwd()` command. Please instead consider using an [R project][R projects]-oriented workflow and read the [reasons for not using `setwd()`](https://www.tidyverse.org/blog/2017/12/workflow-vs-script/). In brief, your work becomes specific to your computer, file paths used to import and export files become "brittle", and this severely hinders collaboration and use of your code on any other computer. There are easy alternatives!

As noted above, although we do not recommend this approach in most circumstances, you can use the command `setwd()` with the desired folder file path in quotations, for example:

```{r, eval=F}
setwd("C:/Documents/R Files/My analysis")
```

[***DANGER:*** Setting a working directory with `setwd()` *can* be "brittle" if the file path is specific to one computer. Instead, use file paths relative to an R Project root directory (with the **here** package).]{style="color: red;"}

<!-- ======================================================= -->

### Set manually {.unnumbered}

To set the working directory manually (the point-and-click equivalent of `setwd()`), click the Session drop-down menu and go to "Set Working Directory" and then "Choose Directory". This will set the working directory for that specific R session. Note: if using this approach, you will have to do this manually each time you open RStudio.

<!-- ======================================================= -->

### Within an R project {.unnumbered}

If using an R project, the working directory will default to the R project root folder that contains the ".rproj" file. This will apply if you open RStudio by clicking open the R Project (the file with ".rproj" extension).

<!-- ======================================================= -->

### Working directory in an R markdown {.unnumbered}

In an R markdown script, the default working directory is the folder the Rmarkdown file (`.Rmd`) is saved within. If using an R project and **here** package, this does not apply and the working directory will be `here()` as explained in the [R projects] page.

If you want to change the working directory of a stand-alone R markdown (not in an R project), if you use `setwd()` this will only apply to that specific code chunk. To make the change for all code chunks in an R markdown, edit the setup chunk to add the `root.dir =` parameter, such as below:

```{r, eval=F}
knitr::opts_knit$set(root.dir = 'desired/directorypath')
```

It is much easier to just use the R markdown within an R project and use the **here** package.

<!-- ======================================================= -->

### Providing file paths {.unnumbered}

Perhaps the most common source of frustration for an R beginner (at least on a Windows machine) is typing in a file path to import or export data. There is a thorough explanation of how to best input file paths in the [Import and export] page, but here are a few key points:

**Broken paths**

Below is an example of an "absolute" or "full address" file path. These will likely break if used by another computer. One exception is if you are using a shared/network drive.

    C:/Users/Name/Document/Analytic Software/R/Projects/Analysis2019/data/March2019.csv  

**Slash direction**

*If typing in a file path, be aware the direction of the slashes.* Use *forward slashes* (`/`) to separate the components ("data/provincial.csv"). For Windows users, the default way that file paths are displayed is with *back slashes* (\\) - so you will need to change the direction of each slash. If you use the **here** package as described in the [R projects] page the slash direction is not an issue.

**Relative file paths**

We generally recommend providing "relative" filepaths instead - that is, the path *relative to* the root of your R Project. You can do this using the **here** package as explained in the [R projects] page. A relativel filepath might look like this:

```{r, eval=F}
# Import csv linelist from the data/linelist/clean/ sub-folders of an R project
linelist <- import(here("data", "clean", "linelists", "marin_country.csv"))
```

Even if using relative file paths within an R project, you can still use absolute paths to import/export data outside your R project.

<!-- ======================================================= -->

## Objects {#objects}

Everything in R is an object, and R is an "object-oriented" language. These sections will explain:

-   How to create objects (`<-`)
-   Types of objects (e.g. data frames, vectors..)\
-   How to access subparts of objects (e.g. variables in a dataset)\
-   Classes of objects (e.g. numeric, logical, integer, double, character, factor)

<!-- ======================================================= -->

### Everything is an object {.unnumbered}

*This section is adapted from the [R4Epis project](https://r4epis.netlify.app/training/r_basics/objects/).*\
Everything you store in R - datasets, variables, a list of village names, a total population number, even outputs such as graphs - are **objects** which are **assigned a name** and **can be referenced** in later commands.

An object exists when you have assigned it a value (see the assignment section below). When it is assigned a value, the object appears in the Environment (see the upper right pane of RStudio). It can then be operated upon, manipulated, changed, and re-defined.

<!-- ======================================================= -->

### Defining objects (`<-`) {.unnumbered}

**Create objects *by assigning them a value* with the \<- operator.**\
You can think of the assignment operator `<-` as the words "is defined as". Assignment commands generally follow a standard order:

**object_name** \<- **value** (or process/calculation that produce a value)

For example, you may want to record the current epidemiological reporting week as an object for reference in later code. In this example, the object `current_week` is created when it is assigned the value `"2018-W10"` (the quote marks make this a character value). The object `current_week` will then appear in the RStudio Environment pane (upper-right) and can be referenced in later commands.

See the R commands and their output in the boxes below.

```{r basics_objects_assignment}
current_week <- "2018-W10"   # this command creates the object current_week by assigning it a value
current_week                 # this command prints the current value of current_week object in the console
```

[***NOTE:*** Note the `[1]` in the R console output is simply indicating that you are viewing the first item of the output]{style="color: black;"}

[***CAUTION:*** **An object's value can be over-written** at any time by running an assignment command to re-define its value. Thus, the **order of the commands run is very important**.]{style="color: orange;"}

The following command will re-define the value of `current_week`:

```{r basics_objects_reassignment}
current_week <- "2018-W51"   # assigns a NEW value to the object current_week
current_week                 # prints the current value of current_week in the console
```

**Equals signs `=`**

You will also see equals signs in R code:

-   A double equals sign `==` between two objects or values asks a logical *question*: "is this equal to that?".\
-   You will also see equals signs within functions used to specify values of function arguments (read about these in sections below), for example `max(age, na.rm = TRUE)`.\
-   You *can* use a single equals sign `=` in place of `<-` to create and define objects, but this is discouraged. You can read about why this is discouraged [here](https://renkun.me/2014/01/28/difference-between-assignment-operators-in-r/).

**Datasets**

Datasets are also objects (typically "dataframes") and must be assigned names when they are imported. In the code below, the object `linelist` is created and assigned the value of a CSV file imported with the **rio** package and its `import()` function.

```{r basics_objects_dataframes, eval=FALSE}
# linelist is created and assigned the value of the imported CSV file
linelist <- import("my_linelist.csv")
```

You can read more about importing and exporting datasets with the section on [Import and export].

[***CAUTION:*** A quick note on naming of objects:]{style="color: orange;"}

-   Object names must not contain spaces, but you should use underscore (\_) or a period (.) instead of a space.\
-   Object names are case-sensitive (meaning that Dataset_A is different from dataset_A).
-   Object names must begin with a letter (cannot begin with a number like 1, 2 or 3).

**Outputs**

Outputs like tables and plots provide an example of how outputs can be saved as objects, or just be printed without being saved. A cross-tabulation of gender and outcome using the **base** R function `table()` can be printed directly to the R console (*without* being saved).

```{r}
# printed to R console only
table(linelist$gender, linelist$outcome)
```

But the same table can be saved as a named object. Then, optionally, it can be printed.

```{r}
# save
gen_out_table <- table(linelist$gender, linelist$outcome)

# print
gen_out_table
```

**Columns**

Columns in a dataset are also objects and can be defined, over-written, and created as described below in the section on Columns.

You can use the assignment operator from **base** R to create a new column. Below, the new column `bmi` (Body Mass Index) is created, and for each row the new value is result of a mathematical operation on the row's value in the `wt_kg` and `ht_cm` columns.

```{r, eval=F}
# create new "bmi" column using base R syntax
linelist$bmi <- linelist$wt_kg / (linelist$ht_cm/100)^2
```

However, in this handbook, we emphasize a different approach to defining columns, which uses the function `mutate()` from the **dplyr** package and *piping* with the pipe operator (`%>%`). The syntax is easier to read and there are other advantages explained in the page on [Cleaning data and core functions]. You can read more about *piping* in the Piping section below.

```{r, eval=F}
# create new "bmi" column using dplyr syntax
linelist <- linelist %>% 
  mutate(bmi = wt_kg / (ht_cm/100)^2)
```

<!-- ======================================================= -->

### Object structure {.unnumbered}

**Objects can be a single piece of data (e.g. `my_number <- 24`), or they can consist of structured data.**

The graphic below is borrowed from [this online R tutorial](http://venus.ifca.unican.es/Rintro/dataStruct.html). It shows some common data structures and their names. Not included in this image is spatial data, which is discussed in the [GIS basics] page.

```{r basics_objects_structures, echo=F, out.width = "75%", out.height="50%", fig.align = "center"}
knitr::include_graphics(here::here("images", "R_data_structures.png"))
```

In epidemiology (and particularly field epidemiology), you will *most commonly* encounter data frames and vectors:

+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| Common structure | Explanation                                                                                      | Example                                                                             |
+==================+==================================================================================================+=====================================================================================+
| Vectors          | A container for a sequence of singular objects, all of the same class (e.g. numeric, character). | **"Variables" (columns) in data frames are vectors** (e.g. the column `age_years`). |
+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| Data Frames      | Vectors (e.g. columns) that are bound together that all have the same number of rows.            | `linelist` is a data frame.                                                         |
+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+

Note that to create a vector that "stands alone" (is not part of a data frame) the function `c()` is used to combine the different elements. For example, if creating a vector of colors plot's color scale: `vector_of_colors <- c("blue", "red2", "orange", "grey")`

<!-- ======================================================= -->

### Object classes {.unnumbered}

All the objects stored in R have a *class* which tells R how to handle the object. There are many possible classes, but common ones include:

+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Class      | Explanation                                                                                                                                                                             | Examples                                                                                              |
+============+=========================================================================================================================================================================================+=======================================================================================================+
| Character  | These are text/words/sentences **"within quotation marks"**. Math cannot be done on these objects.                                                                                      | "Character objects are in quotation marks"                                                            |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Integer    | Numbers that are **whole only** (no decimals)                                                                                                                                           | -5, 14, or 2000                                                                                       |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Numeric    | These are numbers and **can include decimals**. If within quotation marks they will be considered character class.                                                                      | 23.1 or 14                                                                                            |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Factor     | These are vectors that have a **specified order** or hierarchy of values                                                                                                                | An variable of economic status with ordered values                                                    |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Date       | **Once R is told that certain data are Dates**, these data can be manipulated and displayed in special ways. See the page on [Working with dates] for more information.                 | 2018-04-12 or 15/3/1954 or Wed 4 Jan 1980                                                             |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Logical    | Values must be one of the two special values TRUE or FALSE (note these are **not** "TRUE" and "FALSE" in quotation marks)                                                               | TRUE or FALSE                                                                                         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| data.frame | A data frame is how R stores a **typical dataset**. It consists of vectors (columns) of data bound together, that all have the same number of observations (rows).                      | The example AJS dataset named `linelist_raw` contains 68 variables with 300 observations (rows) each. |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| tibble     | tibbles are a variation on data frame, the main operational difference being that they print more nicely to the console (display first 10 rows and only columns that fit on the screen) | Any data frame, list, or matrix can be converted to a tibble with `as_tibble()`                       |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| list       | A list is like vector, but holds other objects that can be other different classes                                                                                                      | A list could hold a single number, and a dataframe, and a vector, and even another list within it!    |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+

**You can test the class of an object by providing its name to the function `class()`**. Note: you can reference a specific column within a dataset using the `$` notation to separate the name of the dataset and the name of the column.

```{r, echo=TRUE,}
class(linelist)         # class should be a data frame or tibble

class(linelist$age)     # class should be numeric

class(linelist$gender)  # class should be character
```

Sometimes, a column will be converted to a different class automatically by R. Watch out for this! For example, if you have a vector or column of numbers, but a character value is inserted... the entire column will change to class character.

```{r}
num_vector <- c(1,2,3,4,5) # define vector as all numbers
class(num_vector)          # vector is numeric class
num_vector[3] <- "three"   # convert the third element to a character
class(num_vector)          # vector is now character class
```

One common example of this is when manipulating a data frame in order to print a table - if you make a total row and try to paste/glue together percents in the same cell as numbers (e.g. `23 (40%)`), the entire numeric column above will convert to character and can no longer be used for mathematical calculations.**Sometimes, you will need to convert objects or columns to another class.**

+------------------+---------------------------------------------------------------------------------------+
| Function         | Action                                                                                |
+==================+=======================================================================================+
| `as.character()` | Converts to character class                                                           |
+------------------+---------------------------------------------------------------------------------------+
| `as.numeric()`   | Converts to numeric class                                                             |
+------------------+---------------------------------------------------------------------------------------+
| `as.integer()`   | Converts to integer class                                                             |
+------------------+---------------------------------------------------------------------------------------+
| `as.Date()`      | Converts to Date class - Note: see section on [dates](#dates) for details             |
+------------------+---------------------------------------------------------------------------------------+
| `factor()`       | Converts to factor - Note: re-defining order of value levels requires extra arguments |
+------------------+---------------------------------------------------------------------------------------+

Likewise, there are **base** R functions to check whether an object IS of a specific class, such as `is.numeric()`, `is.character()`, `is.double()`, `is.factor()`, `is.integer()`

Here is [more online material on classes and data structures in R](https://swcarpentry.github.io/r-novice-inflammation/13-supp-data-structures/).

<!-- ======================================================= -->

### Columns/Variables (`$`) {.unnumbered}

**A column in a data frame is technically a "vector" (see table above)** - a series of values that must all be the same class (either character, numeric, logical, etc).

A vector can exist independent of a data frame, for example a vector of column names that you want to include as explanatory variables in a model. To create a "stand alone" vector, use the `c()` function as below:

```{r, warning=F, message=F}
# define the stand-alone vector of character values
explanatory_vars <- c("gender", "fever", "chills", "cough", "aches", "vomit")

# print the values in this named vector
explanatory_vars
```

**Columns in a data frame are also vectors and can be called, referenced, extracted, or created using the `$` symbol.** The `$` symbol connects the name of the column to the name of its data frame. In this handbook, we try to use the word "column" instead of "variable".

```{r basics_objects_call, eval=F}
# Retrieve the length of the vector age_years
length(linelist$age) # (age is a column in the linelist data frame)

```

By typing the name of the dataframe followed by `$` you will also see a drop-down menu of all columns in the data frame. You can scroll through them using your arrow key, select one with your Enter key, and avoid spelling mistakes!

```{r echo=F, out.width = "100%", fig.align = "center"}
knitr::include_graphics(here::here("images", "Calling_Names.gif"))
```

[***ADVANCED TIP:*** Some more complex objects (e.g. a list, or an `epicontacts` object) may have multiple levels which can be accessed through multiple dollar signs. For example `epicontacts$linelist$date_onset`]{style="color: darkgreen;"}

<!-- ======================================================= -->

### Access/index with brackets (`[ ]`) {.unnumbered}

You may need to view parts of objects, also called "indexing", which is often done using the square brackets `[ ]`. Using `$` on a dataframe to access a column is also a type of indexing.

```{r}
my_vector <- c("a", "b", "c", "d", "e", "f")  # define the vector
my_vector[5]                                  # print the 5th element
```

Square brackets also work to return specific parts of an returned output, such as the output of a `summary()` function:

```{r}
# All of the summary
summary(linelist$age)

# Just the second element of the summary, with name (using only single brackets)
summary(linelist$age)[2]

# Just the second element, without name (using double brackets)
summary(linelist$age)[[2]]

# Extract an element by name, without showing the name
summary(linelist$age)[["Median"]]

```

Brackets also work on data frames to view specific rows and columns. You can do this using the syntax `dataframe[rows, columns]`:

```{r basics_objects_access, eval=F}
# View a specific row (2) from dataset, with all columns (don't forget the comma!)
linelist[2,]

# View all rows, but just one column
linelist[, "date_onset"]

# View values from row 2 and columns 5 through 10
linelist[2, 5:10] 

# View values from row 2 and columns 5 through 10 and 18
linelist[2, c(5:10, 18)] 

# View rows 2 through 20, and specific columns
linelist[2:20, c("date_onset", "outcome", "age")]

# View rows and columns based on criteria
# *** Note the dataframe must still be named in the criteria!
linelist[linelist$age > 25 , c("date_onset", "outcome", "age")]

# Use View() to see the outputs in the RStudio Viewer pane (easier to read) 
# *** Note the capital "V" in View() function
View(linelist[2:20, "date_onset"])

# Save as a new object
new_table <- linelist[2:20, c("date_onset")] 
```

Note that you can also achieve the above row/column indexing on data frames and tibbles using **dplyr** syntax (functions `filter()` for rows, and `select()` for columns). Read more about these core functions in the [Cleaning data and core functions] page.

To filter based on "row number", you can use the **dplyr** function `row_number()` with open parentheses as part of a logical filtering statement. Often you will use the `%in%` operator and a range of numbers as part of that logical statement, as shown below. To see the *first* N rows, you can also use the special **dplyr** function `head()`.

```{r, eval=F}
# View first 100 rows
linelist %>% head(100)

# Show row 5 only
linelist %>% filter(row_number() == 5)

# View rows 2 through 20, and three specific columns (note no quotes necessary on column names)
linelist %>% filter(row_number() %in% 2:20) %>% select(date_onset, outcome, age)
```

When indexing an object of class **list**, single brackets always return with class list, even if only a single object is returned. Double brackets, however, can be used to access a single element and return a different class than list.\
Brackets can also be written after one another, as demonstrated below.

This [visual explanation of lists indexing, with pepper shakers](https://r4ds.had.co.nz/vectors.html#lists-of-condiments) is humorous and helpful.

```{r}
# define demo list
my_list <- list(
  # First element in the list is a character vector
  hospitals = c("Central", "Empire", "Santa Anna"),
  
  # second element in the list is a data frame of addresses
  addresses   = data.frame(
    street = c("145 Medical Way", "1048 Brown Ave", "999 El Camino"),
    city   = c("Andover", "Hamilton", "El Paso")
    )
  )
```

Here is how the list looks when printed to the console. See how there are two named elements:

-   `hospitals`, a character vector\
-   `addresses`, a data frame of addresses

```{r}
my_list
```

Now we extract, using various methods:

```{r}
my_list[1] # this returns the element in class "list" - the element name is still displayed

my_list[[1]] # this returns only the (unnamed) character vector

my_list[["hospitals"]] # you can also index by name of the list element

my_list[[1]][3] # this returns the third element of the "hospitals" character vector

my_list[[2]][1] # This returns the first column ("street") of the address data frame

```

<!-- ======================================================= -->

### Remove objects {.unnumbered}

You can remove individual objects from your R environment by putting the name in the `rm()` function (no quote marks):

```{r, eval=F}
rm(object_name)
```

You can remove all objects (clear your workspace) by running:

```{r, eval=F}
rm(list = ls(all = TRUE))
```

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Piping (`%>%`)

**Two general approaches to working with objects are:**

1)  **Pipes/tidyverse** - pipes send an object from function to function - emphasis is on the *action*, not the object\
2)  **Define intermediate objects** - an object is re-defined again and again - emphasis is on the object

<!-- ======================================================= -->

### **Pipes** {.unnumbered}

**Simply explained, the pipe operator (`%>%`) passes an intermediate output from one function to the next.**\
You can think of it as saying "then". Many functions can be linked together with `%>%`.

-   **Piping emphasizes a sequence of actions, not the object the actions are being performed on**\
-   Pipes are best when a sequence of actions must be performed on one object\
-   Pipes come from the package **magrittr**, which is automatically included in packages **dplyr** and **tidyverse**
-   Pipes can make code more clean and easier to read, more intuitive

Read more on this approach in the tidyverse [style guide](https://style.tidyverse.org/pipes.html)

Here is a fake example for comparison, using fictional functions to "bake a cake". First, the pipe method:

```{r piping_example_pipe, eval=F}
# A fake example of how to bake a cake using piping syntax

cake <- flour %>%       # to define cake, start with flour, and then...
  add(eggs) %>%   # add eggs
  add(oil) %>%    # add oil
  add(water) %>%  # add water
  mix_together(         # mix together
    utensil = spoon,
    minutes = 2) %>%    
  bake(degrees = 350,   # bake
       system = "fahrenheit",
       minutes = 35) %>%  
  let_cool()            # let it cool down
```

Here is another [link](https://cfss.uchicago.edu/notes/pipes/#:~:text=Pipes%20are%20an%20extremely%20useful,code%20and%20combine%20multiple%20operations) describing the utility of pipes.

Piping is not a **base** function. To use piping, the **magrittr** package must be installed and loaded (this is typically done by loading **tidyverse** or **dplyr** package which include it). You can [read more about piping in the magrittr documentation](https://magrittr.tidyverse.org/).

Note that just like other R commands, pipes can be used to just display the result, or to save/re-save an object, depending on whether the assignment operator `<-` is involved. See both below:

```{r, eval=F}
# Create or overwrite object, defining as aggregate counts by age category (not printed)
linelist_summary <- linelist %>% 
  count(age_cat)
```

```{r}
# Print the table of counts in the console, but don't save it
linelist %>% 
  count(age_cat)
```

**`%<>%`**\
This is an "assignment pipe" from the **magrittr** package, which *pipes an object forward and also re-defines the object*. It must be the first pipe operator in the chain. It is shorthand. The below two commands are equivalent:

```{r, eval=F}
linelist <- linelist %>%
  filter(age > 50)

linelist %<>% filter(age > 50)
```

<!-- ======================================================= -->

### Define intermediate objects {.unnumbered}

This approach to changing objects/dataframes may be better if:

-   You need to manipulate multiple objects\
-   There are intermediate steps that are meaningful and deserve separate object names

**Risks:**

-   Creating new objects for each step means creating lots of objects. If you use the wrong one you might not realize it!\
-   Naming all the objects can be confusing\
-   Errors may not be easily detectable

Either name each intermediate object, or overwrite the original, or combine all the functions together. All come with their own risks.

Below is the same fake "cake" example as above, but using this style:

```{r piping_example_redefine, eval=F}
# a fake example of how to bake a cake using this method (defining intermediate objects)
batter_1 <- left_join(flour, eggs)
batter_2 <- left_join(batter_1, oil)
batter_3 <- left_join(batter_2, water)

batter_4 <- mix_together(object = batter_3, utensil = spoon, minutes = 2)

cake <- bake(batter_4, degrees = 350, system = "fahrenheit", minutes = 35)

cake <- let_cool(cake)
```

Combine all functions together - this is difficult to read:

```{r eval=F}
# an example of combining/nesting mutliple functions together - difficult to read
cake <- let_cool(bake(mix_together(batter_3, utensil = spoon, minutes = 2), degrees = 350, system = "fahrenheit", minutes = 35))
```

<!-- ======================================================= -->

## Key operators and functions {#operators}

This section details operators in R, such as:

-   Definitional operators\
-   Relational operators (less than, equal too..)\
-   Logical operators (and, or...)\
-   Handling missing values\
-   Mathematical operators and functions (+/-, \>, sum(), median(), ...)\
-   The `%in%` operator

<!-- ======================================================= -->

### Assignment operators {.unnumbered}

**`<-`**

The basic assignment operator in R is `<-`. Such that `object_name <- value`.\
This assignment operator can also be written as `=`. We advise use of `<-` for general R use.\
We also advise surrounding such operators with spaces, for readability.

**`<<-`**

If [Writing functions], or using R in an interactive way with sourced scripts, then you may need to use this assignment operator `<<-` (from **base** R). This operator is used to define an object in a higher 'parent' R Environment. See this [online reference](https://stat.ethz.ch/R-manual/R-devel/library/base/html/assignOps.html).

**`%<>%`**

This is an "assignment pipe" from the **magrittr** package, which pipes an object forward and *also re-defines the object*. It must be the first pipe operator in the chain. It is shorthand, as shown below in two equivalent examples:

```{r, eval=F}
linelist <- linelist %>% 
  mutate(age_months = age_years * 12)
```

The above is equivalent to the below:

```{r, eval=F}
linelist %<>% mutate(age_months = age_years * 12)
```

**`%<+%`**

This is used to add data to phylogenetic trees with the **ggtree** package. See the page on [Phylogenetic trees] or this online [resource book](https://yulab-smu.top/treedata-book/).

<!-- ======================================================= -->

### Relational and logical operators {.unnumbered}

Relational operators compare values and are often used when defining new variables and subsets of datasets. Here are the common relational operators in R:

+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Meaning                  | Operator   | Example      | Example Result                                                                                                                                         |
+==========================+============+==============+========================================================================================================================================================+
| Equal to                 | `==`       | `"A" == "a"` | `FALSE` (because R is case sensitive) *Note that == (double equals) is different from = (single equals), which acts like the assignment operator `<-`* |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Not equal to             | `!=`       | `2 != 0`     | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Greater than             | `>`        | `4 > 2`      | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Less than                | `<`        | `4 < 2`      | `FALSE`                                                                                                                                                |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Greater than or equal to | `>=`       | `6 >= 4`     | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Less than or equal to    | `<=`       | `6 <= 4`     | `FALSE`                                                                                                                                                |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Value is missing         | `is.na()`  | `is.na(7)`   | `FALSE` (see page on [Missing data])                                                                                                                   |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Value is not missing     | `!is.na()` | `!is.na(7)`  | `TRUE`                                                                                                                                                 |
+--------------------------+------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+

Logical operators, such as AND and OR, are often used to connect relational operators and create more complicated criteria. Complex statements might require parentheses ( ) for grouping and order of application.

+-------------+-----------------------------------------------------------------------+
| Meaning     | Operator                                                              |
+=============+=======================================================================+
| AND         | `&`                                                                   |
+-------------+-----------------------------------------------------------------------+
| OR          | `|` (vertical bar)                                                    |
+-------------+-----------------------------------------------------------------------+
| Parentheses | `( )` Used to group criteria together and clarify order of operations |
+-------------+-----------------------------------------------------------------------+

For example, below, we have a linelist with two variables we want to use to create our case definition, `hep_e_rdt`, a test result and `other_cases_in_hh`, which will tell us if there are other cases in the household. The command below uses the function `case_when()` to create the new variable `case_def` such that:

```{r eval=FALSE}
linelist_cleaned <- linelist %>%
  mutate(case_def = case_when(
    is.na(rdt_result) & is.na(other_case_in_home)            ~ NA_character_,
    rdt_result == "Positive"                                 ~ "Confirmed",
    rdt_result != "Positive" & other_cases_in_home == "Yes"  ~ "Probable",
    TRUE                                                     ~ "Suspected"
  ))
```

+------------------------------------------------------------------------------------------------+--------------------------------------------+
| Criteria in example above                                                                      | Resulting value in new variable "case_def" |
+================================================================================================+============================================+
| If the value for variables `rdt_result` and `other_cases_in_home` are missing                  | `NA` (missing)                             |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If the value in `rdt_result` is "Positive"                                                     | "Confirmed"                                |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If the value in `rdt_result` is NOT "Positive" AND the value in `other_cases_in_home` is "Yes" | "Probable"                                 |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If one of the above criteria are not met                                                       | "Suspected"                                |
+------------------------------------------------------------------------------------------------+--------------------------------------------+

*Note that R is case-sensitive, so "Positive" is different than "positive"...*

<!-- ======================================================= -->

### Missing values {.unnumbered}

In R, missing values are represented by the special value `NA` (a "reserved" value) (capital letters N and A - not in quotation marks). If you import data that records missing data in another way (e.g. 99, "Missing", or .), you may want to re-code those values to `NA`. How to do this is addressed in the [Import and export] page.

**To test whether a value is `NA`, use the special function `is.na()`**, which returns `TRUE` or `FALSE`.

```{r basics_operators_missing}
rdt_result <- c("Positive", "Suspected", "Positive", NA)   # two positive cases, one suspected, and one unknown
is.na(rdt_result)  # Tests whether the value of rdt_result is NA
```

Read more about missing, infinite, `NULL`, and impossible values in the page on [Missing data]. Learn how to convert missing values when importing data in the page on [Import and export].

<!-- ======================================================= -->

### Mathematics and statistics {.unnumbered}

All the operators and functions in this page are automatically available using **base** R.

#### Mathematical operators {.unnumbered}

These are often used to perform addition, division, to create new columns, etc. Below are common mathematical operators in R. Whether you put spaces around the operators is not important.

| Purpose             | Example in R |
|---------------------|--------------|
| addition            | 2 + 3        |
| subtraction         | 2 - 3        |
| multiplication      | 2 \* 3       |
| division            | 30 / 5       |
| exponent            | 2\^3         |
| order of operations | ( )          |

#### Mathematical functions {.unnumbered}

| Purpose            | Function                              |
|--------------------|---------------------------------------|
| rounding           | round(x, digits = n)                  |
| rounding           | janitor::round_half_up(x, digits = n) |
| ceiling (round up) | ceiling(x)                            |
| floor (round down) | floor(x)                              |
| absolute value     | abs(x)                                |
| square root        | sqrt(x)                               |
| exponent           | exponent(x)                           |
| natural logarithm  | log(x)                                |
| log base 10        | log10(x)                              |
| log base 2         | log2(x)                               |

Note: for `round()` the `digits =` specifies the number of decimal placed. Use `signif()` to round to a number of significant figures.

#### Scientific notation {.unnumbered}

The likelihood of scientific notation being used depends on the value of the `scipen` option.

From the documentation of `?options`: scipen is a penalty to be applied when deciding to print numeric values in fixed or exponential notation. Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than 'scipen' digits wider.

If it is set to a low number (e.g. 0) it will be "turned on" always. To "turn off" scientific notation in your R session, set it to a very high number, for example:

```{r, eval=F}
# turn off scientific notation
options(scipen=999)
```

#### Rounding {.unnumbered}

[***DANGER:*** `round()` uses "banker's rounding" which rounds up from a .5 only if the upper number is even. Use `round_half_up()` from **janitor** to consistently round halves up to the nearest whole number. See [this explanation](https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html#explore-records-with-duplicated-values-for-specific-combinations-of-variables-with-get_dupes)]{style="color: red;"}

```{r}
# use the appropriate rounding function for your work
round(c(2.5, 3.5))

janitor::round_half_up(c(2.5, 3.5))
```

#### Statistical functions {.unnumbered}

[***CAUTION:*** The functions below will by default include missing values in calculations. Missing values will result in an output of `NA`, unless the argument `na.rm = TRUE` is specified. This can be written shorthand as `na.rm = T`.]{style="color: orange;"}

| Objective               | Function           |
|-------------------------|--------------------|
| mean (average)          | mean(x, na.rm=T)   |
| median                  | median(x, na.rm=T) |
| standard deviation      | sd(x, na.rm=T)     |
| quantiles\*             | quantile(x, probs) |
| sum                     | sum(x, na.rm=T)    |
| minimum value           | min(x, na.rm=T)    |
| maximum value           | max(x, na.rm=T)    |
| range of numeric values | range(x, na.rm=T)  |
| summary\*\*             | summary(x)         |

Notes:

-   `*quantile()`: `x` is the numeric vector to examine, and `probs =` is a numeric vector with probabilities within 0 and 1.0, e.g `c(0.5, 0.8, 0.85)`
-   `**summary()`: gives a summary on a numeric vector including mean, median, and common percentiles

[***DANGER:*** If providing a vector of numbers to one of the above functions, be sure to wrap the numbers within `c()` .]{style="color: red;"}

```{r}
# If supplying raw numbers to a function, wrap them in c()
mean(1, 6, 12, 10, 5, 0)    # !!! INCORRECT !!!  

mean(c(1, 6, 12, 10, 5, 0)) # CORRECT
```

#### Other useful functions {.unnumbered}

+----------------------------+-------------------+-------------------------------------------------+
| Objective                  | Function          | Example                                         |
+============================+===================+=================================================+
| create a sequence          | seq(from, to, by) | `seq(1, 10, 2)`                                 |
+----------------------------+-------------------+-------------------------------------------------+
| repeat x, n times          | rep(x, ntimes)    | `rep(1:3, 2)` or `rep(c("a", "b", "c"), 3)`     |
+----------------------------+-------------------+-------------------------------------------------+
| subdivide a numeric vector | cut(x, n)         | `cut(linelist$age, 5)`                          |
+----------------------------+-------------------+-------------------------------------------------+
| take a random sample       | sample(x, size)   | `sample(linelist$id, size = 5, replace = TRUE)` |
+----------------------------+-------------------+-------------------------------------------------+

<!-- ======================================================= -->

### `%in%` {.unnumbered}

A very useful operator for matching values, and for quickly assessing if a value is within a vector or dataframe.

```{r}
my_vector <- c("a", "b", "c", "d")
```

```{r}
"a" %in% my_vector
"h" %in% my_vector
```

To ask if a value is **not** `%in%` a vector, put an exclamation mark (!) **in front** of the logic statement:

```{r}
# to negate, put an exclamation in front
!"a" %in% my_vector
!"h" %in% my_vector
```

`%in%` is very useful when using the **dplyr** function `case_when()`. You can define a vector previously, and then reference it later. For example:

```{r eval=F}
affirmative <- c("1", "Yes", "YES", "yes", "y", "Y", "oui", "Oui", "Si")

linelist <- linelist %>% 
  mutate(child_hospitaled = case_when(
    hospitalized %in% affirmative & age < 18 ~ "Hospitalized Child",
    TRUE                                      ~ "Not"))
```

Note: If you want to detect a partial string, perhaps using `str_detect()` from **stringr**, it will not accept a character vector like `c("1", "Yes", "yes", "y")`. Instead, it must be given a *regular expression* - one condensed string with OR bars, such as "1\|Yes\|yes\|y". For example, `str_detect(hospitalized, "1|Yes|yes|y")`. See the page on [Characters and strings] for more information.

You can convert a character vector to a named regular expression with this command:

```{r}
affirmative <- c("1", "Yes", "YES", "yes", "y", "Y", "oui", "Oui", "Si")
affirmative

# condense to 
affirmative_str_search <- paste0(affirmative, collapse = "|")  # option with base R
affirmative_str_search <- str_c(affirmative, collapse = "|")   # option with stringr package

affirmative_str_search
```

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Errors & warnings

This section explains:

-   The difference between errors and warnings\
-   General syntax tips for writing R code\
-   Code assists

Common errors and warnings and troubleshooting tips can be found in the page on [Errors and help].

<!-- ======================================================= -->

### Error versus Warning {.unnumbered}

When a command is run, the R Console may show you warning or error messages in red text.

-   A **warning** means that R has completed your command, but had to take additional steps or produced unusual output that you should be aware of.

-   An **error** means that R was not able to complete your command.

Look for clues:

-   The error/warning message will often include a line number for the problem.

-   If an object "is unknown" or "not found", perhaps you spelled it incorrectly, forgot to call a package with library(), or forgot to re-run your script after making changes.

If all else fails, copy the error message into Google along with some key terms - chances are that someone else has worked through this already!

<!-- ======================================================= -->

### General syntax tips {.unnumbered}

A few things to remember when writing commands in R, to avoid errors and warnings:

-   Always close parentheses - tip: count the number of opening "(" and closing parentheses ")" for each code chunk
-   Avoid spaces in column and object names. Use underscore ( \_ ) or periods ( . ) instead
-   Keep track of and remember to separate a function's arguments with commas
-   R is case-sensitive, meaning `Variable_A` is *different* from `variable_A`

<!-- ======================================================= -->

### Code assists {.unnumbered}

Any script (RMarkdown or otherwise) will give clues when you have made a mistake. For example, if you forgot to write a comma where it is needed, or to close a parentheses, RStudio will raise a flag on that line, on the right side of the script, to warn you.
