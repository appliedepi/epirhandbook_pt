<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>23 Séries temporais e detecção de surtos | Manual de R para Epidemiologistas</title>
<meta name="author" content="the handbook team">
<meta name="description" content="23.1 Visão geral do tópico Esta página demonstra o uso de diferentes pacotes para analisar séries temporais. São utilizados, principalmente, os pacotes da família tidyverts , mas também o pacote...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="23 Séries temporais e detecção de surtos | Manual de R para Epidemiologistas">
<meta property="og:type" content="book">
<meta property="og:description" content="23.1 Visão geral do tópico Esta página demonstra o uso de diferentes pacotes para analisar séries temporais. São utilizados, principalmente, os pacotes da família tidyverts , mas também o pacote...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="23 Séries temporais e detecção de surtos | Manual de R para Epidemiologistas">
<meta name="twitter:description" content="23.1 Visão geral do tópico Esta página demonstra o uso de diferentes pacotes para analisar séries temporais. São utilizados, principalmente, os pacotes da família tidyverts , mas também o pacote...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.29/datatables.js"></script><link href="libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.2.0/leaflet.js"></script><script src="libs/leaflet-providers-1.13.0/leaflet-providers_1.13.0.js"></script><script src="libs/leaflet-providers-plugin-2.2.0/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.10/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.2/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.11.1/plotly-basic-2.11.1.min.js"></script><script src="libs/plotly-cartesian-2.11.1/plotly-cartesian-2.11.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script>
</head>
<body>
<div class="alert alert-info alert-dismissible">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
      <strong>Você precisa de ajuda para aprender R?</strong> Inscreva-se no curso de <a href="https://www.appliedepi.org/live/" class="alert-link">introdução ao R</a> da Applied Epi, experimente nossos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriais gratuitos sobre o R</a>, publique em nosso <a href="https://community.appliedepi.org/" class="alert-link">fórum de perguntas e respostas</a>, ou solicite nosso <a href="mailto:contact@appliedepi.org" class="alert-link">suporte ao R</a>.
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Manual de R para Epidemiologistas</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">Sobre este livro</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> Notas editoriais e técnicas</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> Baixe o livro e os dados</a></li>
<li class="book-part">Básico</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> Introdução ao R</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Transição para o R</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> Pacotes sugeridos</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R projects</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> Importar e exportar</a></li>
<li class="book-part">Gerenciamento dos Dados</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> Limpeza de dados e principais funções</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> Trabalhando com datas</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> Caracteres e strings</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> Fatores</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> Pivoteando dados</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> Agrupando dados</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> Juntando dados (Joins)</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> Eliminação de duplicidades</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> Iterações, loops e listas</a></li>
<li class="book-part">Análise dos dados</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> Tabelas descritivas</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> Testes estatísticos simples</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> Regressão simples e múltipla</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> Campos em branco/faltantes</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> Normalização de taxas</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> Médias móveis</a></li>
<li><a class="active" href="time-series.html"><span class="header-section-number">23</span> Séries temporais e detecção de surtos</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> Modelagem de epidemias</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> Rastreamento de contatos</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> Analises de pesquisa de questionários (survey)</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> Análise de sobrevivência</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> Introdução ao GIS</a></li>
<li class="book-part">Visualização de Dados</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> Tabelas para apresentação</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> O básico do ggplot</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> Dicas do ggplot</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> Curvas epidêmicas</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> Pirâmides demográficas e escalas Likert</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> Gráficos de calor</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> Diagramas e gráficos</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> Análise de Combinações</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> Cadeias de Transmissão</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> Árvores filogenéticas</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> Gráficos interativos</a></li>
<li class="book-part">Relatórios e dashboards</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> Relatórios com R Markdown</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> Organização de relatórios de rotina</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> Painéis (Dashboards) com R Markdown</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Painéis com Shiny</a></li>
<li class="book-part">Miscelânea</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> Escrevendo funções</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> Interações de diretório</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Controle de versão e colaboração com Git e Github</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> Erros comuns</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> Conseguindo ajuda</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> R em drives (pastas) na rede</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> Data Table</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="time-series" class="section level1" number="23">
<h1>
<span class="header-section-number">23</span> Séries temporais e detecção de surtos<a class="anchor" aria-label="anchor" href="#time-series"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="visão-geral-do-tópico" class="section level2" number="23.1">
<h2>
<span class="header-section-number">23.1</span> Visão geral do tópico<a class="anchor" aria-label="anchor" href="#vis%C3%A3o-geral-do-t%C3%B3pico"><i class="fas fa-link"></i></a>
</h2>
<p>Esta página demonstra o uso de diferentes pacotes para analisar séries temporais.
São utilizados, principalmente, os pacotes da família <a href="https://tidyverts.org/"><strong>tidyverts</strong></a>
, mas também o pacote RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a>
para aprimorar modelos mais apropriados para epidemiologia de doenças infecciosas.</p>
<p>Observe que, no exemplo abaixo, nós utilizamos um banco de dados do pacote <strong>surveillance</strong>
sobre a Campylobacter na Alemanha (veja o <a href="https://epirhandbook.com/download-handbook-and-data.html">capítulo sobre dados</a>,
deste manual para mais detalhes). Entretanto, se você quiser executar o mesmo código em um banco de dados
com múltiplos países, ou outros estratos, então aqui está um exemplo de código para isto no
<a href="https://github.com/R4EPI/epitsa">repositório do r4epis no github</a>.</p>
<p>Tópicos abordados incluem:</p>
<ol style="list-style-type: decimal">
<li>Dados com séries temporais</li>
<li>Análise descritiva</li>
<li>Ajustando regressões</li>
<li>Relação de duas séries temporais</li>
<li>Detecção de surtos</li>
<li>Séries temporais interrompidas</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="preparação-13" class="section level2" number="23.2">
<h2>
<span class="header-section-number">23.2</span> Preparação<a class="anchor" aria-label="anchor" href="#prepara%C3%A7%C3%A3o-13"><i class="fas fa-link"></i></a>
</h2>
<div id="carregue-os-pacotes-r-4" class="section level3 unnumbered">
<h3>Carregue os pacotes R<a class="anchor" aria-label="anchor" href="#carregue-os-pacotes-r-4"><i class="fas fa-link"></i></a>
</h3>
<p>O código abaixo realiza o carregamento dos pacotes necessários para a análise dos dados. Neste manual, enfatizamos o uso da função <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code>, do <strong>pacman</strong>, que instala os pacotes, caso não estejam instalados, <em>e</em> os carrega no R para utilização. Também é possível carregar pacotes instalados utilizando a função <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>, do R <strong>base</strong>. Para mais informações sobre os pacotes do R, veja a página <a href="basics.html#basics">Introdução ao R</a>.</p>
<div class="sourceCode" id="cb1108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># Importar arquivos</span></span>
<span>               <span class="va">here</span>,         <span class="co"># Localizar arquivos</span></span>
<span>               <span class="va">tidyverse</span>,    <span class="co"># gerenciamento de dados + gráficos ggplot2</span></span>
<span>               <span class="va">tsibble</span>,      <span class="co"># trabalhe com dados de séries temporais</span></span>
<span>               <span class="va">slider</span>,       <span class="co"># para calcular médias móveis</span></span>
<span>               <span class="va">imputeTS</span>,     <span class="co"># para preencher campos em branco</span></span>
<span>               <span class="va">feasts</span>,       <span class="co"># para decomposição de séries temporais e autocorrelações</span></span>
<span>               <span class="va">forecast</span>,     <span class="co"># ajusta senos e cosenos nos dados (nota: precisa ser carregado após pacote feasts)</span></span>
<span>               <span class="va">trending</span>,     <span class="co"># ajusta e visualizada modelos</span></span>
<span>               <span class="va">tmaptools</span>,    <span class="co"># para obter coordenadas geográficas (long/lat) baseado no nome dos locais</span></span>
<span>               <span class="va">ecmwfr</span>,       <span class="co"># para interagir com o satélite copernicus CDS API</span></span>
<span>               <span class="va">stars</span>,        <span class="co"># para ler arquivos em .nc (dados climáticos)</span></span>
<span>               <span class="va">units</span>,        <span class="co"># para definir unidades de medida (dados climáticos)</span></span>
<span>               <span class="va">yardstick</span>,    <span class="co"># para avaliar a acurácia do modelo</span></span>
<span>               <span class="va">surveillance</span>, <span class="co"># para detecção de aberrações</span></span>
<span>               <span class="va">ncmeta</span>        <span class="co"># ler arquivos .nc</span></span>
<span>               <span class="op">)</span></span></code></pre></div>
</div>
<div id="carregue-os-dados-no-r" class="section level3 unnumbered">
<h3>Carregue os dados no R<a class="anchor" aria-label="anchor" href="#carregue-os-dados-no-r"><i class="fas fa-link"></i></a>
</h3>
<p>Você pode baixar todos os dados utilizados neste manual através das instruções na página de <a href="data-used.html#data-used">download do manual e dos dados</a>.</p>
<p>Os dados utilizados nessa seção para fins de exemplificação são as contagens semanais de casos de campylobacter notificados na Alemanha entre 2001 e 2011. <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx" class="download-button">
Você pode clicar aqui para baixar<span> este arquivo de dados (.xlsx).</span></a></p>
<p>Este banco de dados é uma versão reduzida do banco de dados disponível no pacote <a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a>.
(para mais detalhes, carregue o pacote surveillance e veja <code>?campyDE</code>)</p>
<p>Importe estes dados com a função <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> do pacote <strong>rio</strong> (ele manipula muitos tipos de arquivos, como .xlsx, .csv, .rds - veja a página sobre <a href="importing.html#importing">Importar e exportar</a> para mais detalhes).</p>
<div class="sourceCode" id="cb1109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># importe as contagens para o R</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"campylobacter_germany.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>As primeiras 10 linhas da contagem são mostradas abaixo.</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-3361792c41b05367e8c7" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-3361792c41b05367e8c7">{"x":{"filter":"none","vertical":false,"data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="limpe-os-dados" class="section level3 unnumbered">
<h3>Limpe os dados<a class="anchor" aria-label="anchor" href="#limpe-os-dados"><i class="fas fa-link"></i></a>
</h3>
<p>O código abaixo garante que a coluna de datas esteja no formato apropriado.
Nesta página, iremos utilizar o pacote <strong>tsibble</strong> com funções <code>yearweek</code>
que serão usadas para criar uma variável com um calendário de semanas. Existem outras
maneiras de fazer isso (veja a página <a href="dates.html#dates">trabalhando com datas</a>
para mais detalhes), entretanto, para séries temporais é melhor nos mantermos dentro de um único tipo de abordagem (<strong>tsibble</strong>).</p>
<div class="sourceCode" id="cb1110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## garanta que a coluna com datas estejam no formato apropriado</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## crie uma variável com semanas do calendário</span></span>
<span><span class="co">## ajuste definições ISO de semanas iniciando na segunda</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">yearweek</span><span class="op">(</span><span class="va">date</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="baixe-download-os-dados-climáticos" class="section level3 unnumbered">
<h3>Baixe (<em>download</em>) os dados climáticos<a class="anchor" aria-label="anchor" href="#baixe-download-os-dados-clim%C3%A1ticos"><i class="fas fa-link"></i></a>
</h3>
<p>Na seção sobre a <em>relação de duas séries temporais</em> nesta página, nós iremos comparar
contagens de casos de campylobacter com dados climáticos.</p>
<p>Dados climáticos de qualquer lugar do mundo podem ser baixados do Satélite Copernicus da União Européia
Estas não são medições exatas, mas baseadas em um modelo (similar a
interpolação). Entretanto, o benefício é a cobertura global a cada hora, bem como previsões.</p>
<p>Você pode baixar cada um desses arquivos de dados climáticos da página <a href="data-used.html#data-used">Download do manual e dos dados</a>.</p>
<p>Para fins de demonstração, nós iremos mostrar códigos em R que utilizam o pacote <strong>ecmwfr</strong> para baixar esses dados do repositório
do Copernicus. Você precisa criar uma conta gratuita para que isto
funcione. O website do pacote tem um <a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">passo a passo</a>
útil de como fazer isto. Quando tiver as chaves API apropriadas, o código abaixo é um exemplo de como proceder.
Você precisa substituir o X abaixo com o ID da sua conta.
Você só pode baixar um ano de dados por vez. Do contrário, o tempo do servidor expira.</p>
<p>Se você não tiver certeza das coordenadas de uma localização que quer baixar os dados,
é possível utilizar o pacote <strong>tmaptools</strong> para baixar as coordenadas de um mapa <em>open street</em>.
Outra alternativa é o pacote <a href="https://github.com/rCarto/photon"><strong>photon</strong></a>, entretanto ele ainda não foi liberado no CRAN; algo interessante do<br><strong>photon</strong> é que ele fornece mais dados contextuais caso existam diferentes
resultados para o que se busca.</p>
<div class="sourceCode" id="cb1111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## recupere as coordenadas de localização</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">geocode_OSM</span><span class="op">(</span><span class="st">"Germany"</span>, geometry <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## baixe as long/lats juntas no formado para busca no ERA-5 (caixa de delimitação) </span></span>
<span><span class="co">## (como só quer um único ponto, pode repetir as coordenadas)</span></span>
<span><span class="va">request_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue_data</a></span><span class="op">(</span><span class="va">coords</span><span class="op">$</span><span class="va">coords</span>, <span class="st">"{y}/{x}/{y}/{x}"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Baixando dados modelados do satélite copernicus (reanálise ERA-5)</span></span>
<span><span class="co">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span></span>
<span><span class="co">## https://github.com/bluegreen-labs/ecmwfr</span></span>
<span></span>
<span><span class="co">## configure uma chave para os dados climáticos</span></span>
<span><span class="fu">wf_set_key</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"XXXXX"</span>,</span>
<span>           key <span class="op">=</span> <span class="st">"XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX"</span>,</span>
<span>           service <span class="op">=</span> <span class="st">"cds"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## para cada ano de interesse, execute o código (do contrário o tempo do servidor expira)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2011</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## monte uma requisição (*Query*)</span></span>
<span>  <span class="co">## veja aqui para como fazer isso: https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span></span>
<span>  <span class="co">## altere o pedido para uma lista utilizando o botão *addin* acima (python para lista)</span></span>
<span>  <span class="co">## O alvo é o nome do arquivo de saída!!</span></span>
<span>  <span class="va">request</span> <span class="op">&lt;-</span> <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    product_type <span class="op">=</span> <span class="st">"reanalysis"</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"netcdf"</span>,</span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2m_temperature"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,</span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span><span class="op">)</span>,</span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span>,</span>
<span>            <span class="st">"13"</span>, <span class="st">"14"</span>, <span class="st">"15"</span>, <span class="st">"16"</span>, <span class="st">"17"</span>, <span class="st">"18"</span>, <span class="st">"19"</span>, <span class="st">"20"</span>, <span class="st">"21"</span>, <span class="st">"22"</span>, <span class="st">"23"</span>, <span class="st">"24"</span>,</span>
<span>            <span class="st">"25"</span>, <span class="st">"26"</span>, <span class="st">"27"</span>, <span class="st">"28"</span>, <span class="st">"29"</span>, <span class="st">"30"</span>, <span class="st">"31"</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"00:00"</span>, <span class="st">"01:00"</span>, <span class="st">"02:00"</span>, <span class="st">"03:00"</span>, <span class="st">"04:00"</span>, <span class="st">"05:00"</span>, <span class="st">"06:00"</span>, <span class="st">"07:00"</span>,</span>
<span>             <span class="st">"08:00"</span>, <span class="st">"09:00"</span>, <span class="st">"10:00"</span>, <span class="st">"11:00"</span>, <span class="st">"12:00"</span>, <span class="st">"13:00"</span>, <span class="st">"14:00"</span>, <span class="st">"15:00"</span>,</span>
<span>             <span class="st">"16:00"</span>, <span class="st">"17:00"</span>, <span class="st">"18:00"</span>, <span class="st">"19:00"</span>, <span class="st">"20:00"</span>, <span class="st">"21:00"</span>, <span class="st">"22:00"</span>, <span class="st">"23:00"</span><span class="op">)</span>,</span>
<span>    area <span class="op">=</span> <span class="va">request_coords</span>,</span>
<span>    dataset_short_name <span class="op">=</span> <span class="st">"reanalysis-era5-single-levels"</span>,</span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"germany_weather"</span>, <span class="va">i</span>, <span class="st">".nc"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## baixe o aquivo e armazene-o no diretório de trabalho atual</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span>user     <span class="op">=</span> <span class="st">"XXXXX"</span>,  <span class="co"># ID do usuário (para autenticação)</span></span>
<span>                     request  <span class="op">=</span> <span class="va">request</span>,  <span class="co"># o pedido</span></span>
<span>                     transfer <span class="op">=</span> <span class="cn">TRUE</span>,     <span class="co"># baixe o arquivo</span></span>
<span>                     path     <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"weather"</span><span class="op">)</span><span class="op">)</span> <span class="co">## diretório para salvar os dados</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
<div id="carregue-os-dados-climáticos" class="section level3 unnumbered">
<h3>Carregue os dados climáticos<a class="anchor" aria-label="anchor" href="#carregue-os-dados-clim%C3%A1ticos"><i class="fas fa-link"></i></a>
</h3>
<p>Se você baixou os dados climáticos seguindo o nosso manual, ou se utilizou o código acima, agora você deve ter 10 anos de arquivos com dados climáticos “.nc” armazenados na mesma pasta do seu computador.</p>
<p>Utilize o código abaixo para importar estes arquivos no R com o pacote <strong>stars</strong>.</p>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina o diretório para a pasta de clima</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span></span>
<span>  <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"time_series"</span>, <span class="st">"weather"</span><span class="op">)</span>, <span class="co"># substitua com o seu próprio endereço de arquivos</span></span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## mantenha apenas os arquivos que tenham o nome de interesse atual</span></span>
<span> <span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="va">file_paths</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">file_paths</span>, <span class="st">"germany"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## leia todos os arquivos como um objeto stars</span></span>
<span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>Uma vez que estes arquivos foram importados como o objeto <code>data</code>, nós iremos convertê-los para um quadro de dados (<em>data frame</em>).</p>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## mude para um quadro de dados (*data frame*)</span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## adicione variáveis e corrija unidades</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## crie uma variável com um calendário semanal</span></span>
<span>    epiweek <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-week.html">yearweek</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, </span>
<span>    <span class="co">## crie uma variável de data (início do calendário semanal)</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span>,</span>
<span>    <span class="co">## mude a temperatura de kelvin para celsius</span></span>
<span>    t2m <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">t2m</span>, <span class="va">celsius</span><span class="op">)</span>, </span>
<span>    <span class="co">## altere a precipitação de metros para milímetros</span></span>
<span>    tp  <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">tp</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## agrupe por semana (mantenha a semana também)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## obtenha a média por semana</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>t2m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">t2m</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'epiweek'. You can override using the `.groups`
## argument.</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="dados-de-séries-temporais" class="section level2" number="23.3">
<h2>
<span class="header-section-number">23.3</span> Dados de séries temporais<a class="anchor" aria-label="anchor" href="#dados-de-s%C3%A9ries-temporais"><i class="fas fa-link"></i></a>
</h2>
<p>Existem diferentes pacotes para estruturar e manipular dados de séries temporais.
Como dito, nós iremos focar nos pacotes da família <strong>tidyverts</strong>, e, assim,
utilizar o pacote <strong>tsibble</strong> para definir nosso objeto de séries temporais. Definir os dados
como um objeto de séries temporais significa que é muito mais fácil estruturar a nossa análise.</p>
<p>Para fazer isso, nós utilizamos a função <code>tsibble()</code> e especificamos o “index”. Por exemplo, a variável especificando
a unidade de tempo de interesse. No nosso caso, esta é a variável <code>epiweek</code>.</p>
<p>Se nós tivéssemos dados com contagens semanais por províncias, por exemplo, também seríamos
capazes de especificar a variável de agrupamento utilizando o argumento <code>key =</code>.
Isto iria nos permitir realizar a análise para cada grupo.</p>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina o objeto da série temporal</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span></code></pre></div>
<p>Ao executar <code>class(counts)</code> nota-se que, além de ser um quadro de dados (<em>data frame</em>) organizado
(“tbl_df”, “tbl”, “data.frame”), ele tem propriedades adicionais de um quadro de dados
de uma série temporal (“tbl_ts”).</p>
<p>Você pode analisar rapidamente os seus dados ao utilizar o <strong>ggplot2</strong>. Nós vemos pelo gráfico que
existe um padrão sazonal óbvio, e que não existem campos em branco. Entretanto, parece
existir um erro para notificar os casos no começo de cada ano; o número de casos cai
na última semana do ano, e então aumenta na primeira semana do ano seguinte.</p>
<div class="sourceCode" id="cb1117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## trace um gráfico de linha de casos por semana</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot-1.png" width="672"></div>
<p><span style="color: red;"><strong><em>PERIGO:</em></strong> Boa parte dos bancos de dados não são limpos como o deste exemplo.
Você irá precisar checar por duplicatas e campos em branco como mostrado abaixo. </span></p>
<!-- ======================================================= -->
<div id="dados-duplicados" class="section level3 unnumbered">
<h3>Dados duplicados<a class="anchor" aria-label="anchor" href="#dados-duplicados"><i class="fas fa-link"></i></a>
</h3>
<p><strong>tsibble</strong> não permite observações duplicadas. Então, cada linha precisa ser
única, ou única dentro de um grupo (variável <code>key</code>).
O pacote tem algumas funções que ajudam a identificar duplicatas. Estes incluem
a função <code>are_duplicated()</code>, que gera um vetor TRUE/FALSE caso a linha seja uma
duplicata, e a função <code>duplicates()</code> que gera um quadro de dados com as linhas duplicadas.</p>
<p>Veja a página sobre <a href="deduplication.html#deduplication">Eliminando duplicidades</a>
para mais detalhes sobre como selecionar as linhas que você quer.</p>
<div class="sourceCode" id="cb1118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## obtenha um vetor de TRUE/FALSE caso as linhas sejam duplicatas</span></span>
<span><span class="fu">are_duplicated</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## obtenha um quadro de dados (*data frame*) das linhas duplicadas</span></span>
<span><span class="fu">duplicates</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="campos-em-branco" class="section level3 unnumbered">
<h3>Campos em branco<a class="anchor" aria-label="anchor" href="#campos-em-branco"><i class="fas fa-link"></i></a>
</h3>
<p>Por meio da breve inspeção demonstrada acima, nós vimos que não existem campos em branco em nossos dados, mas também
notamos que existe um problema com atrasos de notificação próximo ao ano novo.
Uma forma de abordar isto seria atribuir campos vazios a esses valores, e então
inserir novos valores. A forma mais simples de iserção (<em>input</em>) em uma série temporal é desenhar
uma linha reta entre o último valor preenchido e o próximo valor preenchido (entre os campos em branco).
Para fazer isso, nós iremos utilizar a função <code>na_interpolation()</code> do pacote <strong>imputeTS</strong>.</p>
<p>Veja a página sobre <a href="missing-data.html#missing-data">Dados faltantes</a> para mais informações sobre imputação.</p>
<p>Outra alternativa seria calcular a média móvel, para tentar suavizar
esses problemas aparentes de notificação (veja a próxima seção, e a página sobre <a href="moving-average.html#moving-average">médias móveis</a>).</p>
<div class="sourceCode" id="cb1119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## crie uma variálvel com campos em branco em vez das semanas com problemas na notificação</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_miss <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>          <span class="co">## se as semanas epidemilógicas contém 52, 53, 1 or 2</span></span>
<span>          <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="st">"W51|W52|W53|W01|W02"</span><span class="op">)</span>, </span>
<span>          <span class="co">## então troque para missing</span></span>
<span>          <span class="cn">NA_real_</span>, </span>
<span>          <span class="co">## do contrário mantenha o valor do campo</span></span>
<span>          <span class="va">case</span></span>
<span>     <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## alternativamente interpole os campos em branco por uma tendência linear</span></span>
<span><span class="co">## entre os dois pontos adjacentes mais próximos</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_int <span class="op">=</span> <span class="fu">imputeTS</span><span class="fu">::</span><span class="fu"><a href="https://SteffenMoritz.github.io/imputeTS/reference/na_interpolation.html">na_interpolation</a></span><span class="op">(</span><span class="va">case_miss</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co">## para checar quais valores foram imputados comparados com os originais</span></span>
<span><span class="fu">ggplot_na_imputations</span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_miss</span>, <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## crie um gráfico tradicional (com eixos negros e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/missings-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="análise-descritiva" class="section level2" number="23.4">
<h2>
<span class="header-section-number">23.4</span> Análise descritiva<a class="anchor" aria-label="anchor" href="#an%C3%A1lise-descritiva"><i class="fas fa-link"></i></a>
</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>Médias móveis<a class="anchor" aria-label="anchor" href="#timeseries_moving"><i class="fas fa-link"></i></a>
</h3>
<p>Se os dados apresentam muitos ruídos (contagens pulando para cima e para baixo), então pode ser útil
calcular a média móvel. No exemplo abaixo, para cada semana nós calculamos o
número médio de casos das quatro semanas anteriores. Isto suaviza os dados para
torná-los mais fáceis de interpretar. No nosso caso, isto não traz grandes vantagens, então
nós iremos manter os dados interpolados para mais análises.
Veja a página sobre <a href="moving-average.html#moving-average">Médias móveis</a> para mais detalhes.</p>
<div class="sourceCode" id="cb1120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## crie uma variável de média móvel (o que resolve o problema dos campos em branco)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="co">## crie a variável ma_4w </span></span>
<span>     <span class="co">## passe por cada linha da variável dos casos</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ma_4wk <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">case</span>, </span>
<span>                               <span class="co">## para cada linha, calcule a média</span></span>
<span>                               <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                               <span class="co">## use as quatro semanas anteriores</span></span>
<span>                               .before <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## faça uma visualização rápida da diferença</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ma_4wk</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/moving_averages-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="peridiocidade" class="section level3 unnumbered">
<h3>Peridiocidade<a class="anchor" aria-label="anchor" href="#peridiocidade"><i class="fas fa-link"></i></a>
</h3>
<p>Abaixo, nós definimos uma função customizada para criar um periodograma. Veja a página sobre <a href="writing-functions.html#writing-functions">Escrevendo funções</a> para informações sobre como escrever funções no R.</p>
<p>Primeiro, a função é definida. Seus argumentos incluem um banco de dados com uma coluna <code>counts</code>, <code>start_week =</code> que é a primeira semana do banco de dados, um número para indicar quantos períodos por ano (ex.: 52, 12), e, por último, o estilo da saída da análise (veja detalhes no código abaixo).</p>
<div class="sourceCode" id="cb1121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Argumentos da função</span></span>
<span><span class="co">#####################</span></span>
<span><span class="co">## x é um banco de dados</span></span>
<span><span class="co">## counts é uma variável com dados contados ou com taxas em x</span></span>
<span><span class="co">## start_week é a primeira semana do banco de dados</span></span>
<span><span class="co">## period são quantas unidades em um ano</span></span>
<span><span class="co">## output é caso você queira retornar um periodograma espectral, ou as semanas de pico</span></span>
<span>  <span class="co">## "periodogram" ou "weeks"</span></span>
<span></span>
<span><span class="co"># Defina a função</span></span>
<span><span class="va">periodogram</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                        <span class="va">counts</span>, </span>
<span>                        <span class="va">start_week</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                        <span class="va">period</span> <span class="op">=</span> <span class="fl">52</span>, </span>
<span>                        <span class="va">output</span> <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span></span>
<span>    <span class="co">## garanta que não é uma classe tsibble, filtre por projeto e mantenha apenas as colunas de interesse</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prepare_data</span>, <span class="op">{</span><span class="op">{</span><span class="va">counts</span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## crie uma zona intermediária de série temporal para permitir a utilização no spec.pgram</span></span>
<span>    <span class="va">zoo_cases</span> <span class="op">&lt;-</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/zooreg.html">zooreg</a></span><span class="op">(</span><span class="va">prepare_data</span>, </span>
<span>                             start <span class="op">=</span> <span class="va">start_week</span>, frequency <span class="op">=</span> <span class="va">period</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## obtenha um periodograma espectral sem utilizar a transformação fast fourier </span></span>
<span>    <span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spec.pgram.html">spec.pgram</a></span><span class="op">(</span><span class="va">zoo_cases</span>, fast <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## retorne as semanas com picos de casos</span></span>
<span>    <span class="va">periodo_weeks</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">periodo</span><span class="op">$</span><span class="va">freq</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">period</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">output</span> <span class="op">==</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">periodo_weeks</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">periodo</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## obtenha um periodograma espectral para extrair semanas com as maiores frequências</span></span>
<span><span class="co">## (checando para sazonalidade) </span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                       <span class="va">case_int</span>, </span>
<span>                       start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                       output <span class="op">=</span> <span class="st">"periodogram"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## coloque o espectro e a frequência em um quadro de dados para plotagem</span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">periodo</span><span class="op">$</span><span class="va">freq</span>, <span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## trace um periodograma mostrando a peridiocidade que ocorre mais frequentemente</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">periodo</span>, </span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">periodo.freq</span><span class="op">/</span><span class="fl">52</span><span class="op">)</span>,  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">periodo.spec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Period (Weeks)"</span>, y <span class="op">=</span> <span class="st">"Log(density)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/periodogram-1.png" width="672"></div>
<div class="sourceCode" id="cb1122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## obtenha as semanas em vetor em ordem ascendente</span></span>
<span><span class="va">peak_weeks</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                          <span class="va">case_int</span>, </span>
<span>                          start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                          output <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span></span></code></pre></div>
<p><span style="color: black;"><strong><em>NOTA:</em></strong> É possível utilizar as semanas acima para adicioná-las aos termos de seno e coseno. Entretanto, nós iremos utilizar uma função para gerar esses termos (veja a seção sobre regressão abaixo) </span></p>
<!-- ======================================================= -->
</div>
<div id="decomposição" class="section level3 unnumbered">
<h3>Decomposição<a class="anchor" aria-label="anchor" href="#decomposi%C3%A7%C3%A3o"><i class="fas fa-link"></i></a>
</h3>
<p>Para dividir a série temporal em diferentes partes, a decomposição clássica é utilizada, pois
quando analisadas juntas, é possível verificar um padrão.
Estas partes distintas são:</p>
<ul>
<li>O ciclo-tendência (a tendência dos dados no longo prazo)</li>
<li>A sazonalidade (repetição dos padrões)</li>
<li>O aleatório (o que resta após remover a tendência e a sazonalidade)</li>
</ul>
<div class="sourceCode" id="cb1123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## decomponha os dados de contagem</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># utilizando um modelo clássico de decomposição aditiva</span></span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">classical_decomposition</span><span class="op">(</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extraia a informação importante do modelo</span></span>
<span>  <span class="fu">components</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## gere um gráfico</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/decomposition-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="autocorrelação" class="section level3 unnumbered">
<h3>Autocorrelação<a class="anchor" aria-label="anchor" href="#autocorrela%C3%A7%C3%A3o"><i class="fas fa-link"></i></a>
</h3>
<p>Autocorrelação mostra a relação entre as contagens de cada semana
e das semanas anteriores a la (chamado de lags).</p>
<p>Ao utilizar a função <code>ACF()</code>, nós podemos gerar um gráfico que mostra o número de linhas
em relação aos diferentes defasagens (<em>lags</em>). Quando o <em>lag</em> for 0 (x = 0), esta linha deve ser sempre
1 pois mostra a relação entre uma observação e ela mesma (não mostrado aqui).
A primeira linha mostrada aqui (x = 1) mostra a relação entre cada observação
e a última observação antes dela (<em>lag</em> de 1), a segunda mostra a relação entre
cada observação e a penúltima observação anterior a ela (<em>lag</em> de 2) e assim por diante, até o <em>lag</em> de
52, que mostra a relação entre cada observação e a observação de 1
ano (52 semanas antes).</p>
<p>A função <code>PACF()</code> (para autocorrelação parcial) mostra o mesmo tipo de relação
mas ajustado para todas as outras semanas no intervalo. Isto é menos útil para determinar a
peridiocidade.</p>
<div class="sourceCode" id="cb1124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## utilizando os dados de contagem</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calcule a autocorrelação utilizando defasagens (lags) que cobrem anos completos</span></span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mostre um gráfico</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-1.png" width="672"></div>
<div class="sourceCode" id="cb1125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## utilizando os dados de contagem</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calcule a autocorrelação parcial utilizando lags que cobrem anos completos</span></span>
<span>  <span class="fu">PACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mostre um gráfico</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-2.png" width="672"></div>
<p>Você pode testar formalmente a hipótese nula de independência em uma série temporal (i.e.:
ausência de autocorrelação) utilizando o teste de Ljung-Box (no pacote <strong>stats</strong>).
Um p-valor significantivo sugere que exista uma autocorrelação nos dados.</p>
<div class="sourceCode" id="cb1126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## avalia a existência de autocorrelação</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="ajustando-regressões" class="section level2" number="23.5">
<h2>
<span class="header-section-number">23.5</span> Ajustando regressões<a class="anchor" aria-label="anchor" href="#ajustando-regress%C3%B5es"><i class="fas fa-link"></i></a>
</h2>
<p>É possível ajustar uma vasta quantidade de diferentes regressões em uma série temporal.
Entretanto, aqui nós iremos demonstrar como ajustar uma regressão binominal negativa - uma<br>
vez que frequentemente esta é a mais apropriada para dados de contagem em doenças infecciosas.</p>
<!-- ======================================================= -->
<div id="termos-de-fourier" class="section level3 unnumbered">
<h3>Termos de Fourier<a class="anchor" aria-label="anchor" href="#termos-de-fourier"><i class="fas fa-link"></i></a>
</h3>
<p>Termos de Fourier são os equivalentes de curvas seno e coseno. A diferença é que
estes são ajustados com base na identificação da combinação mais apropriada das curvas para explicar
seus dados.</p>
<p>O ajuste de apenas um termo de Fourier equivale a ajustar um seno e um coseno para a defasagem (<em>lag</em>) que ocorre mais frequentemente em seu periodograma (no nosso
caso, de 52 semanas). Para isso, nós utilizamos a função <code>fourier()</code> do pacote <strong>forecast</strong>.</p>
<p>No código abaixo, a atribuição é feita utilizando o <code>$</code>, uma vez que <code>fourier()</code> retorna duas colunas (uma<br>
para seno, outra para coseno) que são adicionadas aos dados como uma lista, chamada
“fourier”, que pode então ser utilizada normalmente como uma variável na regressão.</p>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## adicione os termos de Fourier utilizando as variáveis epiweek e case_int</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="binominal-negativa" class="section level3 unnumbered">
<h3>Binominal negativa<a class="anchor" aria-label="anchor" href="#binominal-negativa"><i class="fas fa-link"></i></a>
</h3>
<p>É possível ajustar regressões utilizando funções básicas do <strong>stats</strong> ou <strong>MASS</strong>
(ex.: <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>, <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> e <code>glm.nb()</code>). Entretanto, nós iremos utilizar as funções do
pacote <strong>trending</strong>, pois ele permite o cálculo apropriado dos intervalos de confiança
e de predição (que de outra forma não estão disponíveis).
A sintaxe é a mesma, em que você especifica uma variável para atribuir o resultado, um til (~),
e então adiciona as variáveis de interesse separadas por um sinal de mais (+).</p>
<p>A outra diferença é que nós primeiro definimos o modelo e então o ajustamos <code>fit()</code> (ajustamos) para os
dados. Isto é útil porque permite a comparação de diferentes modelos
com a mesma sintaxe.</p>
<p><span style="color: darkgreen;"><strong><em>DICA:</em></strong> Se você quiser utilizar taxas, em vez de
contagens, é possível incluir a variável população como um termo logaritmo de compensação, ao adicionar<br><code>offset(log(population)</code>. Para calcular uma taxa, você então precisaria ajustar a população para ser 1, antes de utilizar a função
<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. </span></p>
<p><span style="color: darkgreen;"><strong><em>DICA:</em></strong> Para ajustar modelos mais complexos como
ARIMA ou profeta (prophet), veja o pacote <a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a>. </span></p>
<div class="sourceCode" id="cb1129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## escolha o modelo que você quer ajustar (binominal negativa)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## escolha o número de casos como resultado de interesse</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## utilize a variável epiweek para levar em consideração a tendência</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## utilize os termos de Fourier para levar em consideração a sazonalidade</span></span>
<span>    <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ajuste seu modelo utilizando os dados de contagem</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calcule os intervalos de confiança e predição</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## faça um gráfico da sua regressão</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha para a estimativa do modelo</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma faixa sombreada dos intervalos de predição</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha para o número de casos</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faça um gráfico tradicional (com eixos pretos e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/nb_reg-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="resíduos" class="section level3 unnumbered">
<h3>Resíduos<a class="anchor" aria-label="anchor" href="#res%C3%ADduos"><i class="fas fa-link"></i></a>
</h3>
<p>Para avaliar o quão bem nosso modelo se ajusta aos dados observados, precisamos checar os resíduos.
Os resíduos são a diferença entre as contagens observadas e as contagens
estimadas pelo modelo. Nós podemos calcular isto de forma simples, utilizando <code>case_int - estimate</code>,
mas a função <code><a href="https://rdrr.io/r/stats/residuals.html">residuals()</a></code> extrai isso diretamente da regressão para nós.</p>
<p>O que vemos abaixo é que não estamos explicando toda a variabilidade dos dados com o nosso modelo. Uma possibilidade seria ajustar mais termos de Fourier,
e verificar a amplitude. Entretanto, para este exemplo, nós iremos deixar da forma que está.
Os gráficos mostram que nosso modelo possui pior desempenho nos picos e nas baixas (quando as contagens estão
nas maiores ou nas menores quantidades). Sendo assim, ele provavelmente irá subestimar
as contagens observadas.</p>
<div class="sourceCode" id="cb1130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calcule os resíduos</span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">fitted_model</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## os resíduos são razoavelmente constantes ao longo do tempo (se não: surtos? mudanças na prática?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-1.png" width="672"></div>
<div class="sourceCode" id="cb1131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## existe autocorrelação nos resíduos (existe um padrão para os erros?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-2.png" width="672"></div>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## os resíduos estão distribuídos de forma normal (estão sendo sub ou super estimados?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-3.png" width="672"></div>
<div class="sourceCode" id="cb1133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## compare as contagens observadas com os resíduos</span></span>
<span>  <span class="co">## não deve haver padrão</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-4.png" width="672"></div>
<div class="sourceCode" id="cb1134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## teste formalmente a autocorrelação dos resíduos</span></span>
<span><span class="co">## H0 é que os resíduos são ruídos brancos (i.e.: aleatórios)</span></span>
<span><span class="co">## teste de independência</span></span>
<span><span class="co">## se p-valor for significantivo, então não é aleatório</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 336.25, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="relação-entre-duas-séries-temporais" class="section level2" number="23.6">
<h2>
<span class="header-section-number">23.6</span> Relação entre duas séries temporais<a class="anchor" aria-label="anchor" href="#rela%C3%A7%C3%A3o-entre-duas-s%C3%A9ries-temporais"><i class="fas fa-link"></i></a>
</h2>
<p>Aqui nós vemos como utilizar dados climáticos (especificamente a temperatura) para explicar
a quantidade de casos de campylobacter.</p>
<!-- ======================================================= -->
<div id="unindo-bancos-de-dados" class="section level3 unnumbered">
<h3>Unindo bancos de dados<a class="anchor" aria-label="anchor" href="#unindo-bancos-de-dados"><i class="fas fa-link"></i></a>
</h3>
<p>Nós podemos unir nossos bancos de dados utilizando a variável de semana. Para mais informações sobre junção de dados, veja no
manual a seção sobre <a href="joining-matching.html#joining-matching">unindo dados</a>.</p>
<div class="sourceCode" id="cb1136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## junção à esquerda, de forma que nós teremos apenas as linhas existentes na tabela de contagens</span></span>
<span><span class="co">## exclua a variável date do temp_data (do contrário, ficará duplicada)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp_data</span>, <span class="op">-</span><span class="va">date</span><span class="op">)</span>,</span>
<span>                    by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="análise-descritiva-1" class="section level3 unnumbered">
<h3>Análise descritiva<a class="anchor" aria-label="anchor" href="#an%C3%A1lise-descritiva-1"><i class="fas fa-link"></i></a>
</h3>
<p>Primeiro, faça um gráfico de seus dados para ver se existe alguma relação óbvia.
O gráfico abaixo mostra que existe uma relação clara na sazonalidade das duas
variáveis, e que a temperatura pode aumentar algumas semanas antes da contagem de casos.
Para mais sobre o pivoteamento dos dados, veja a seção sobre <a href="pivoting.html#pivoting">pivoteando dados</a> neste manual.</p>
<div class="sourceCode" id="cb1137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mantenha as variáveis de interesse</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span>, <span class="va">t2m</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mude seus dados para o formato longo</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="co">## use a epiweek como "chave" para união</span></span>
<span>    <span class="op">!</span><span class="va">epiweek</span>,</span>
<span>    <span class="co">## move o nome das colunas para a nova coluna "measure"</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"measure"</span>, </span>
<span>    <span class="co">## move os valores das células para a nova coluna "values"</span></span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## crie um gráfico com os dados acima</span></span>
<span>  <span class="co">## trace um gráifco com a epiweek no eixo x e os valores (contagens/temperatura) no eixo y</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co">## crie um gráfico separado para temperaturas e contagens dos casos</span></span>
<span>    <span class="co">## deixe a escala do eixo y livre</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">measure</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co">## adiciona as informações como uma linha no gráfico</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="lags-e-correlação-cruzada" class="section level3 unnumbered">
<h3>Lags e correlação cruzada<a class="anchor" aria-label="anchor" href="#lags-e-correla%C3%A7%C3%A3o-cruzada"><i class="fas fa-link"></i></a>
</h3>
<p>Para formalmente testar quais semanas estão mais relacionadas com os casos e temperatura.
Nós podemos utilizar a função de correlação cruzada (<code>CCF()</code>) do pacote <strong>feasts</strong>.
Você pode também visualizar (em vez de utilizar <code>arrange</code>) os dados com a função <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code>.</p>
<div class="sourceCode" id="cb1138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calcule a correlação cruzada entre as contagens e temperaturas interpoladas</span></span>
<span>  <span class="fu">CCF</span><span class="op">(</span><span class="va">case_int</span>, <span class="va">t2m</span>,</span>
<span>      <span class="co">## ajuste o lag máximo para 52 semanas</span></span>
<span>      lag_max <span class="op">=</span> <span class="fl">52</span>, </span>
<span>      <span class="co">## retorne o coeficiente de correlação</span></span>
<span>      type <span class="op">=</span> <span class="st">"correlation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## organize pela ordem decrescente do coeficiente de correlação</span></span>
<span>  <span class="co">## mostre as defasagens de tempo com maior associação</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">ccf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## apenas mostre os dez maiores coeficientes</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##         lag   ccf
##    &lt;cf_lag&gt; &lt;dbl&gt;
##  1      -4W 0.749
##  2      -5W 0.745
##  3      -3W 0.735
##  4      -6W 0.729
##  5      -2W 0.727
##  6      -7W 0.704
##  7      -1W 0.695
##  8      -8W 0.671
##  9       0W 0.649
## 10      47W 0.638</code></pre>
<p>A partir disso, nós vemos que uma defasagem (<em>lag</em>) de 4 semanas é o mais altamente correlacionado.
Então, nós criamos uma variável de temperatura com esse <em>lag</em> para incluir em nossa regressão.</p>
<p><span style="color: red;"><strong><em>PERIGO:</em></strong> Observe que as quatro primeiras semanas dos nossos dados
na variável de temperatura com lag estão em branco (<code>NA</code>) - como não existem quatro
semanas anteriores para obter os dados. Para utilizar esses dados com a função <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>,<br>
do pacote <strong>trending</strong>, nós precisamos usar o argumento <code>simulate_pi = FALSE</code> dentro de
<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> nas etapas posteriores. Se nós quiséssemos utilizar a opção de simular, então
precisaríamos excluir esses campos em branco, e salvar um novo conjunto de dados ao adicionar <code>drop_na(t2m_lag4)</code>
ao código abaixo. </span></p>
<div class="sourceCode" id="cb1140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## crie uma nova variável para temperatura com lag de quatro semanas</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>t2m_lag4 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">t2m</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="binominal-negativa-com-duas-variáveis" class="section level3 unnumbered">
<h3>Binominal negativa com duas variáveis<a class="anchor" aria-label="anchor" href="#binominal-negativa-com-duas-vari%C3%A1veis"><i class="fas fa-link"></i></a>
</h3>
<p>Nós ajustamos uma regressão binominal negativa como feito anteriormente. Desta vez, adicionamos
a variável temperatura com uma defasagem de tempo (<em>lag</em>) de quatro semanas.</p>
<p><span style="color: orange;"><strong><em>CUIDADO:</em></strong> Observe o uso do argumento <code>simulate_pi = FALSE</code>
dentro da função <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Isto se deve porque o comportamento padrão de <strong>trending</strong>
é usar o pacote <strong>ciTools</strong> para estimar um intervalo de predição. Isto não
funciona se existirem contagen <code>NA</code>, e também produz intervalos mais granulares.
Veja <code>?trending::predict.trending_model_fit</code> para mais detalhes. </span></p>
<div class="sourceCode" id="cb1141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina o modelo que você quer ajustar (binominal negativa)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## ajuste o número de casos como resultado de interesse</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## use epiweek para levar em conta a tendência</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## use os termos fourier para levar em conta a sazonalidade</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## use a temperatura com lag de quatro semanas</span></span>
<span>    <span class="va">t2m_lag4</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## ajuste seu modelo utilizando os dados de contagem</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calcule os intervalos de confiança e de predição</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Para investigar os termos individual, nós podemos retomar a regressão binominal negativa original
do formato <strong>trending</strong> utilizando a função <code>get_model()</code> e aplica-la na função <code>tidy()</code> function do pacote
<strong>broom</strong> para obter estimativas exponencializadas e intervalos
de confiança associados.</p>
<p>O que isso nos mostra é que a temperatura defasada, depois de controlar o modelo para tendência e sazonalidade,
é similar a contagem dos casos (estimativa ~ 1) e significativamente associada com os casos.
Isto sugere que esta possa ser uma boa variável para prever a quantidade de casos futura
(conforme a previsão do tempo é disponibilizada).</p>
<div class="sourceCode" id="cb1142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extraia a regressão negativa binominal original</span></span>
<span>  <span class="fu">get_fitted_model</span><span class="op">(</span><span class="op">)</span> <span class="co">#%&gt;% </span></span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:  glm.nb(formula = case_int ~ epiweek + fourier + t2m_lag4, data = counts, 
##     init.theta = 32.80689607, link = log)
## 
## Coefficients:
##  (Intercept)       epiweek  fourierS1-52  fourierC1-52      t2m_lag4  
##   5.82535083    0.00008464   -0.28502594   -0.19537827    0.00667157  
## 
## Degrees of Freedom: 504 Total (i.e. Null);  500 Residual
##   (4 observations deleted due to missingness)
## Null Deviance:       2015 
## Residual Deviance: 508.2     AIC: 6784</code></pre>
<div class="sourceCode" id="cb1144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## obtenha um quadro de dados organizado dos resultados</span></span>
<span>  <span class="co"># tidy(exponentiate = TRUE, </span></span>
<span>  <span class="co">#      conf.int = TRUE)</span></span></code></pre></div>
<p>Um inspeção visual rápida do modelo mostra que ele pode fazer um trabalho melhor em
estimar a quantidade de casos observada.</p>
<div class="sourceCode" id="cb1145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## faça um gráfico da sua regressão</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha com a estimativa do modelo</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma faixa sombreada dos intervalos de predição</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha com a quantidade de casos observada</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faça uma gráfico tradicional (com eixos pretos e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672"></div>
<div id="resíduos-1" class="section level4 unnumbered">
<h4>Resíduos<a class="anchor" aria-label="anchor" href="#res%C3%ADduos-1"><i class="fas fa-link"></i></a>
</h4>
<p>Aqui, novamente avaliaremos os resíduos para ver o quão bem o nosso modelo se ajusta aos dados observados.
Os resultados e a interpretação são similares àqueles da regressão anterior,
então pode ser mais viável continuar com o modelo mais simples, sem a temperatura.</p>
<div class="sourceCode" id="cb1146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calcule os resíduos</span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">case_int</span> <span class="op">-</span> <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## os resíduos são razoavelmente constantes ao longo do tempo (caso não: surtos? mudanças na prática?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-1.png" width="672"></div>
<div class="sourceCode" id="cb1147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## existe uma autocorrelação nos resíduos (existe um padrão para o erro?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-2.png" width="672"></div>
<div class="sourceCode" id="cb1148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## os resíduos são normalmente distribuídos (estão sub ou super estimando?)?</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-3.png" width="672"></div>
<div class="sourceCode" id="cb1149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## compare as contagens observadas com os seus resíduos</span></span>
<span>  <span class="co">## também não deve haver padrão</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-4.png" width="672"></div>
<div class="sourceCode" id="cb1150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## formalmente avalie a autocorrelação dos resíduos</span></span>
<span><span class="co">## H0 é que os resíduos são uma série de ruídos brancos (i.e.: aleatórios)</span></span>
<span><span class="co">## teste de independência</span></span>
<span><span class="co">## se o p-valor for signficativo, então os resíduos não são aleatórios</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="detecção-de-surtos" class="section level2" number="23.7">
<h2>
<span class="header-section-number">23.7</span> Detecção de surtos<a class="anchor" aria-label="anchor" href="#detec%C3%A7%C3%A3o-de-surtos"><i class="fas fa-link"></i></a>
</h2>
<p>Aqui, nós iremos demonstrar dois métodos similares para detecção de surtos.
O primeiro tem como base as seções acima.
Nós usamos o pacote <strong>trending</strong> para ajustar regressões para os anos anteriores, e então
predizer o que esperar para o próximo ano. Se as contagens observadas estão acima
do esperado, é possível que exista um surto.
O segundo método é baseado em princípios similares, mas utiliza o pacote <strong>surveillance</strong>,
que possui uma variedade de algoritmos diferentes para detecção de anomalias.</p>
<p><span style="color: orange;"><strong><em>CUIDADO:</em></strong> Normalmente, você tem interesse no ano corrente (onde você apenas conhece contagens até a semana atual). Então, neste exemplo, nós fingiremos estar na semana 39 de 2011.</span></p>
<!-- ======================================================= -->
<div id="pacote-trending" class="section level3 unnumbered">
<h3>Pacote <strong>trending</strong><a class="anchor" aria-label="anchor" href="#pacote-trending"><i class="fas fa-link"></i></a>
</h3>
<p>Para este método, nós definimos uma base de referência (usualmente 5 anos de dados).
Nós ajustamos uma regressão com esses dados, e então usamos isto para prever as estimativas
para o próximo ano.</p>
<!-- ======================================================= -->
<div id="data-limite" class="section level4 unnumbered">
<h4>Data limite<a class="anchor" aria-label="anchor" href="#data-limite"><i class="fas fa-link"></i></a>
</h4>
<p>É mais fácil definir suas datas em um local, e então utiliza-las no
resto do seu código.</p>
<p>Aqui, nós definimos uma data de início (quando suas observações começaram) e uma data limite
(o final do seu período de referência - e quando o período que nós queremos prever começa).
~Nós também definimos quantas semanas estão no nosso ano de interesse (o ano que iremos
fazer previsões)~.
E também definimos quantas semanas estão entre o limite do nosso período de referência, e a data final
que estamos interessados em fazer previsões.</p>
<p><span style="color: black;"><strong><em>NOTA:</em></strong> Neste exemplo, nós fingimos estar no final de setembro de 2011 (“2011 W39”).</span></p>
<div class="sourceCode" id="cb1152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina data de início (quando as observações foram iniciadas)</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## defina uma semana limite (final do período de referência, início do período de previsão)</span></span>
<span><span class="va">cut_off</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2010-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## defina a última data de interesse (i.e.: final da previsão)</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2011-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## encontre quantas semanas no período (ano) de interesse</span></span>
<span><span class="va">num_weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_date</span> <span class="op">-</span> <span class="va">cut_off</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="adicione-linhas" class="section level4 unnumbered">
<h4>Adicione linhas<a class="anchor" aria-label="anchor" href="#adicione-linhas"><i class="fas fa-link"></i></a>
</h4>
<p>Para ser capaz de prever no formato tidyverse, nós precisamos ter o número correto
de linhas em nosso banco de dados, i.e.: uma linha para cada semana até a data final (<code>end_date</code>) definida acima.
O código abaixo permite adicionar essas linhas de acordo com uma variável de agrupamento - por exemplo,
se nós tivéssemos múltiplos países em um conjunto de dados, poderíamos agrupar por país e então
adicionar linhas apropriadas para cada um.
A função <code>group_by_key()</code>, do pacote <strong>tsibble</strong>, nos permite fazer esse agrupamento
e então passar os dados agrupados para as funções do <strong>dplyr</strong>, <code><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify()</a></code> e
<code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code>. Então, nós especificamos a sequência de semanas entre a primeira e a última semana
atualmente disponíveis nos dados e a semana final.</p>
<div class="sourceCode" id="cb1153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## adicione semanas em branco até o final do ano</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## agrupe por região</span></span>
<span>  <span class="fu">group_by_key</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## para cada grupo, adicione linhas da maior semana epidemiológica até o final do ano</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>                        epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, </span>
<span>                                      <span class="va">end_date</span>,</span>
<span>                                      by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="termos-de-fourier-1" class="section level4 unnumbered">
<h4>Termos de Fourier<a class="anchor" aria-label="anchor" href="#termos-de-fourier-1"><i class="fas fa-link"></i></a>
</h4>
<p>Nós precisamos redefinir nossos termos de fourier - uma vez que queremos ajustá-los apenas ao período de referência,
e então prever (extrapolar) esses termos para o próximo ano.
Para fazer isso, nós precisamos combinar duas listas geradas da função <code>fourier()</code>;
a primeira se trata dos dados que são a base de referência, e a segunda a previsão para o
ano de interesse (ao definir o argumento <code>h</code>).</p>
<p><em>N.b.</em> para unir linhas, nós temos que usar <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> (em vez da função <code>bind_rows</code> do tidyverse) pois
as colunas fourier estão em forma de lista (logo, não são nomeadas individualmente).</p>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina os termos de fourier (senos e cosenos) </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## combine os termos de fourier para semanas antes e após a data limite de 2010</span></span>
<span>    <span class="co">## (termos de fourier para 2011 e antes são estimados)</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## obtenha termos de fourier dos anos anteriores</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## mantenha apenas as linhas anteriores à 2011</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## inclua um conjunto de termos seno e coseno</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## preveja os termos de fourier para 2011 (utilizando os dados base de referência)</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## mantenha apenas as linhas que estejam dentro do período de interesse</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## inclua um conjunto de termos seno e coseno</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## preveja as 52 semanas seguintes</span></span>
<span>        h <span class="op">=</span> <span class="va">num_weeks</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="divida-os-dados-e-ajuste-a-regressão" class="section level4 unnumbered">
<h4>Divida os dados e ajuste a regressão<a class="anchor" aria-label="anchor" href="#divida-os-dados-e-ajuste-a-regress%C3%A3o"><i class="fas fa-link"></i></a>
</h4>
<p>Agora nós precisamos dividir o nosso banco de dados entre o período de referência e o período a ser
previsto. Isto é feito utilizando a função <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> do pacote <strong>dplyr</strong>, após utilizar <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>,
e irá criar uma lista com dois conjuntos de dados, um para antes do período da previsão, e outro
com esse período.</p>
<p>Então nós utilizamos a função <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> do pacote <strong>purrr</strong>, para extrair o conjunto de dados da
lista (equivalente de utilizar os colchetes quadrados, ex.: <code>dat[[1]]</code>), e então ajustar o
nosso modelo para os dados de referência, e então aplicar a função <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> para as nossas datas de
interesse após a data limite do período de referência.</p>
<p>Veja a página sobre <a href="iteration.html#iteration">Iteração, loops, e listas</a> para aprender mais sobre o pacote <strong>purrr</strong>.</p>
<p><span style="color: orange;"><strong><em>CUIDADO:</em></strong> Observe o uso do argumento <code>simulate_pi = FALSE</code> dentro
de <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Isto é porque o comportamento padrão de <strong>trending</strong>
é utilizar o pacote <strong>ciTools</strong> para estimar o intervalo de previsão. Entretanto, isto não
funciona se existirem contagens de <code>NA</code>, além de produzir mais intervalos granulares.
Veja <code>?trending::predict.trending_model_fit</code> para mais detalhes. </span></p>
<div class="sourceCode" id="cb1155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># divida os dados para ajustes e previsões</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## defina o modelo que você quer ajustar (binominal negativo)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## ajuste o número de casos como resultado de interesse da análise</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## use as semanas epidemiológicas ('epiweek') para considerar a tendência</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## use os termos de fourier para considerar a sazonalidade</span></span>
<span>    <span class="va">fourier</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># defina quais dados utilizar para ajustar o modelo e quais para predizer</span></span>
<span><span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_int</span>, <span class="va">epiweek</span>, <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ajuste o modelo</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">fitting_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># obtenha os intervalos de confiança e estimativas para os dados ajustados</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># faça as previsões com os dados a serem preditos</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">pred_data</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## combine os bancos de dados de referência e os dados preditos</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span>, <span class="va">forecasts</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<p>Como anteriormente, nós podemos visualizar nosso modelo com o <strong>ggplot</strong>. Nós destacamos os alertas de surtos com
pontos vermelhos, para contagens observadas acima de 95% do intervalo de predição.
Desta vez, nós também adicionamos uma linha vertical para indicar onde o período de previsão começa.</p>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## faça gráficos da sua regressão</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha para as estimativas do modelo</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma faixa sombreada com os intervalos de predição</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adiciona uma linha para os as contagens de caso observadas</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## crie pontos para as contagens observadas acima do esperado</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">case_int</span> <span class="op">&gt;</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>    colour <span class="op">=</span> <span class="st">"red"</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione linha vertical e a nomeie para indicar onde a previsão dos casos começou </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">cut_off</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Forecast"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">cut_off</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span> <span class="op">-</span> <span class="fl">250</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## crie um gráfico tradicional (com eixos pretos e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 13 rows containing missing values (`geom_line()`).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/forecast_plot-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="validando-a-previsão-do-número-de-casos" class="section level4 unnumbered">
<h4>Validando a previsão do número de casos<a class="anchor" aria-label="anchor" href="#validando-a-previs%C3%A3o-do-n%C3%BAmero-de-casos"><i class="fas fa-link"></i></a>
</h4>
<p>Além de inspecionar os resíduos, é importante investigar o quão bom o seu modelo é
em prever casos no futuro. Isto te dá uma ideia sobre o quão fidedignos os seus
patamares para alertas são.</p>
<p>A forma tradicional de validar é verificar quão bem você consegue prever o último
ano antes do ano atual (porque você ainda desconhece as contagens para o “ano corrente”).
Por exemplo, em nosso conjunto de dados, nós iríamos utilizar os dados de 2002 a 2009 para prever 2010,
e então ver o quão acuradas estas previsões são. A partir disto, reajustar o modelo para incluir
dados de 2010 e usar para prever as contagens de 2011.</p>
<p>Como pode ser visto na figura abaixo, de <em>Hyndman et al</em> em <a href="https://otexts.com/fpp3">“Princípios e práticas de previsão”</a> .</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png"><em>figura reproduzida com permissão dos autores</em></p>
<p>O ponto negativo desta abordagem é que você não está utilizando todos os dados disponíveis, além de
não ser o modelo final o utilizado para realizar as previsões.</p>
<p>Uma alternativa é utilizar um método chamado de validação cruzada. Neste cenário, você
passa por todos os dados disponíveis para ajustar diferentes modelos para prever um ano à frente.
Você utiliza mais e mais dados em cada modelo, como visto na figura abaixo do
mesmo [texto de <em>Hyndman et al</em>]((<a href="https://otexts.com/fpp3/" class="uri">https://otexts.com/fpp3/</a>).
Por exemplo, o primeiro modelo utiliza dados de 2002 para prever 2003, o segundo usa dados de 2002 e
2003 para prever 2004, e assim por diante.
<img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png"><em>figura reproduzida com permissão dos autores</em></p>
<p>Abaixo, nós utilizamos a função <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> do pacote <strong>purrr</strong> para passar por cada conjunto de dados.
Nós então colocamos estimativas em um banco de dados, e unimos com o número de casos original,
para utilizar o pacote <strong>yardstick</strong> para calcular medidas de acurácia.
Nós calculamos quatro medidas, incluindo: We compute four measures including: erro quadrático médio (RMSE, do inglês Root mean squared error), erro médio absoluto<br>
(MAE), erro médio absoluto em escala (MASE), erro médio percentual absoluto (MAPE).</p>
<p><span style="color: orange;"><strong><em>CUIDADO:</em></strong> observe o uso do argumento <code>simulate_pi = FALSE</code>
dentro de <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Isto é porque o comportamento padrão de <strong>trending</strong>
é utilizar o pacote <strong>ciTools</strong> para estimar um intervalo de previsão. Isto não
funciona caso existam contagens de <code>NA</code>, e também produz mais intervalos granulares.
Veja <code>?trending::predict.trending_model_fit</code> para detalhes. </span></p>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Validação cruzada: prevendo semana(s) à frente baseado na técnica da janela deslizante</span></span>
<span></span>
<span><span class="co">## expanda seus dados, trabalhando com janelas de 52 semanas (antes + depois)</span></span>
<span><span class="co">## para predizer as 52 semanas seguintes</span></span>
<span><span class="co">## (cria correntes de observação mais e mais longas - mantém dados antigos)</span></span>
<span></span>
<span><span class="co">## defina o tamanho da janela a ser trabalhada</span></span>
<span><span class="va">roll_window</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## define weeks ahead want to predict </span></span>
<span><span class="va">weeks_ahead</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## crie um conjunto de dados com dados repetindo e aumentando</span></span>
<span><span class="co">## nomeie cada conjunto de dados com um id único</span></span>
<span><span class="co">## utilize apenas os casos antes do ano de interesse (i.e.: 2011)</span></span>
<span><span class="va">case_roll</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mantenha apenas as variáveis de semana e quantidade de casos</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## exclua as últimas x observações</span></span>
<span>    <span class="co">## dependendo quantas semanas à frente estão sendo previstas</span></span>
<span>    <span class="co">## (do contrário será uma previsão real para "desconhecida")</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">weeks_ahead</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## role por cada semana após x janelas para para criar um ID de agrupamento</span></span>
<span>    <span class="co">## de acordo com qual janela rolante especificar</span></span>
<span>    <span class="fu">stretch_tsibble</span><span class="op">(</span>.init <span class="op">=</span> <span class="va">roll_window</span>, .step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## exclua a primeira dupla - pois não existem casos "antes"</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.id</span> <span class="op">&gt;</span> <span class="va">roll_window</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## para cada um dos conjuntos de dados, execute o código abaixo</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">case_roll</span><span class="op">$</span><span class="va">.id</span><span class="op">)</span>, </span>
<span>                        <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## mantenha apenas a janela atual sendo ajustada no modelo</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">case_roll</span>, <span class="va">.id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## crie um conjunto de dados vazio para fazer as previsões</span></span>
<span>  <span class="va">forecast_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="va">weeks_ahead</span>,</span>
<span>                  by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    case_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">weeks_ahead</span><span class="op">)</span>,</span>
<span>    .id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">weeks_ahead</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## adicione os dados previstos aos originais</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">mini_data</span>, <span class="va">forecast_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## defina o limite de corte baseado nos últimos dados de contagem, com exceção dos dados em branco</span></span>
<span>  <span class="va">cv_cut_off</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## mantenha apenas as linhas sem campos em branco</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## obtenha a última semana</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## extraia os dados de forma que não estejam como quadro de dados</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## crie a variável mini_data de volta como um tsibble</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">mini_data</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## defina os termos de fourier (sincos) </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## combine os termos de fourier para semanas antes e após a data limite</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## obtenha termos de fourier para anos anteriores</span></span>
<span>      <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/fourier.html">fourier</a></span><span class="op">(</span></span>
<span>        <span class="co">## matenha as linhas até a data limite</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## inclua um conjunto de termos seno e coseno</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## preveja os termos courier para o ano seguinte (utilizando os dados base de referências)</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## matenha apenas as linhas antes da data limite</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## inclua um conjunto de termos seno e coseno</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## preveja as 52 semanas à frente</span></span>
<span>        h <span class="op">=</span> <span class="va">weeks_ahead</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># divida os dados para ajustar e prever</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## defina o modelo que você quer ajustar (negativo binominal)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>    <span class="co">## ajuste o número de casos como resultado de interesse</span></span>
<span>    <span class="va">case_int</span> <span class="op">~</span></span>
<span>      <span class="co">## utilize a epiweek para levar em consideração a tendência</span></span>
<span>      <span class="va">epiweek</span> <span class="op">+</span></span>
<span>      <span class="co">## utilize os termos furier para levar em consideração a sazonalidade</span></span>
<span>      <span class="va">fourier</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># defina quais dados utilizar para ajustar e quais para prever</span></span>
<span>  <span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ajuste o modelo</span></span>
<span>  <span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">fitting_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># prejeva com os dados que você quer utilizar para prever</span></span>
<span>  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">pred_data</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span>  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## mantenha apenas a semana e os dados estimados</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## transforme a lista gerada em um quadro de dados com todas as estimativas</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## una as previsões com os dados observados</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">forecasts</span>, </span>
<span>                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span>,</span>
<span>                       by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## utilize {yardstick} para calcular métricas</span></span>
<span>  <span class="co">## RMSE: Erro quadrático médio</span></span>
<span>  <span class="co">## MAE:  Erro médio absoluto</span></span>
<span>  <span class="co">## MASE: Erro médio absoluto escalonado</span></span>
<span>  <span class="co">## MAPE: Erro médio absoluto percentual</span></span>
<span><span class="va">model_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co">## no seu conjunto de dados previstos, compare o observado com o estimado</span></span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>, </span>
<span>  <span class="fu">mae</span><span class="op">(</span> <span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mase</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mape</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mantenha apenas o tipo métrico e o resultado</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Metric  <span class="op">=</span> <span class="va">.metric</span>, </span>
<span>         Measure <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## crie no formato amplo de forma que seja possível unir as linhas posteriormente</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Metric</span>, values_from <span class="op">=</span> <span class="va">Measure</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## retorne as métricas do modelo</span></span>
<span><span class="va">model_metrics</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="pacote-surveillance" class="section level3 unnumbered">
<h3>Pacote <strong>surveillance</strong><a class="anchor" aria-label="anchor" href="#pacote-surveillance"><i class="fas fa-link"></i></a>
</h3>
<p>Nesta seção, nós utilizamos o pacote <strong>surveillance</strong> para criar alertas de acordo com limites
baseados em algorítmos de detecção de surtos. Existem diferentes métodos
disponíveis no pacote. Entretanto, aqui nós iremos focar em duas opções.
Para detalhes, veja esses artigos sobre a <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">aplicação</a>
e <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">teoria</a>
dos algorítmos utilizados.</p>
<p>A primeira opção utiliza o método Farrington melhorado. Isto ajusta uma glm
binominal negativa (incluíndo tendências) e diminui o peso de surtos passados (pontos fora do normal) para
criar um nível de limiar.</p>
<p>A segunda opção utiliza o método glrnb. Isto também ajusta uma glm binominal negativa
mas inclui tendências e termos de fourier (então é a favorita aqui). A regressão é utilizada
para calcular o “controle médio” (~valores ajustados) - ele então utiliza uma razão estatística
generalizada de verosimilhança para avaliar se existe uma mudança na média
de cada semana. Observe que o limiar para cada semana leva em conta semanas
anteriores, então se as mudanças persistirem, um alarme será ativado.
(Adicionalmente, observe que após cada alarme, o algoritmo é reinicilizado)</p>
<p>Para trabalhar com o pacote <strong>surveillance</strong>, nós primeiro precisamos definir um
objeto de “séries temporais de vigilância” (utilizando a função <code>sts()</code>) para ajustar dentro do
quadro.</p>
<div class="sourceCode" id="cb1160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina um objeto de série temporal de vigilância</span></span>
<span><span class="co">## nb. você pode incluir um denominador com o objeto que contém a população (veja ?sts)</span></span>
<span><span class="va">counts_sts</span> <span class="op">&lt;-</span> <span class="fu">sts</span><span class="op">(</span>observed <span class="op">=</span> <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                    <span class="co">## subconjunto para manter apenas o ano da variável start_date</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                    <span class="co">## subconjunto para manter apenas a semana da variável start_date</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                  <span class="co">## defina o tipo/frequência dos dados (neste caso, semanal)</span></span>
<span>                  freq <span class="op">=</span> <span class="fl">52</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## defina o intervalo de semanas que você quer incluir (ex.: período de previsão)</span></span>
<span><span class="co">## nb. o objto sts apenas contabiliza observações sem identificar uma semana ou</span></span>
<span><span class="co">## ano a eles - assim, nós utilizamos nossos dados para definir as observações apropriadas</span></span>
<span><span class="va">weekrange</span> <span class="op">&lt;-</span> <span class="va">cut_off</span> <span class="op">-</span> <span class="va">start_date</span></span></code></pre></div>
<!-- ======================================================= -->
<div id="método-farrington" class="section level4 unnumbered">
<h4>Método Farrington<a class="anchor" aria-label="anchor" href="#m%C3%A9todo-farrington"><i class="fas fa-link"></i></a>
</h4>
<p>Nós então definimos cada um dos nossos parâmetros para o método Farrington em uma <code>list</code> (lista).
Então, nós executamos o algoritmo utilizando a função <code>farringtonFlexible()</code> e então podemos extrair o
limiar para um alerta utilizando <code>farringtonmethod@upperbound</code> para incluir isto em nosso
banco de dados. Também é possível extrair um booleano TRUE/FALSE (VERDADEIRO/FALSO) para cada semana no caso do alerta
ter sido ativado (semana com casos acima do limiar) utilizando <code>farringtonmethod@alarm</code>.</p>
<div class="sourceCode" id="cb1161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina o controle</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## defina qual período de tempo que quer utilizar o limiar (i.e.: 2011)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">9</span>, <span class="co">## quantos anos anteriores para considerar com os dados de referência</span></span>
<span>  w <span class="op">=</span> <span class="fl">2</span>, <span class="co">## tamanho da janela flutuante em semanas</span></span>
<span>  weightsThreshold <span class="op">=</span> <span class="fl">2.58</span>, <span class="co">## reponderando surtos passados (método melhorado de noufaily - método original sugere 1)</span></span>
<span>  <span class="co">## pastWeeksNotIncluded = 3, ## utilize todas as semanas disponíveis (noufaily suggests drop 26)</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pThresholdTrend <span class="op">=</span> <span class="fl">1</span>, <span class="co">## 0.05 normalmente, entretanto 1 é recomendado no método melhorado (i.e.: sempre mantenha)</span></span>
<span>  thresholdMethod <span class="op">=</span> <span class="st">"nbPlugin"</span>,</span>
<span>  populationOffset <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## aplique o método flexível de farrington</span></span>
<span><span class="va">farringtonmethod</span> <span class="op">&lt;-</span> <span class="fu">farringtonFlexible</span><span class="op">(</span><span class="va">counts_sts</span>, <span class="va">ctrl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Crie uma nova variável no conjunto de dados original chamado "threshold"</span></span>
<span><span class="co">## contendo o limite superior do farrington </span></span>
<span><span class="co">## nb. isto é apenas para as semanas em 2011 (então é necessário subdividir as linhas)</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">farringtonmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>Nós podemos, então, visualizar os resultados no ggplot como feito anteriormente.</p>
<div class="sourceCode" id="cb1162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione as quantidades de casos observada como uma linha</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione o limite superior do algoritmo de aberrações</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## defina as cores</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## crie um gráfico tradicional (com eixos pretos e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## remova o título da legenda</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_farrington-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="método-glrnb" class="section level4 unnumbered">
<h4>Método GLRNB<a class="anchor" aria-label="anchor" href="#m%C3%A9todo-glrnb"><i class="fas fa-link"></i></a>
</h4>
<p>De forma similar, para o método GLRNB nós definimos cada um dos nossos parâmetros para em uma <code>list</code> (lista),
então ajuste o algoritmo e extraia os limites superiores.</p>
<p><span style="color: orange;"><strong><em>CUIDADO:</em></strong> Este método utiliza “força bruta” (similar ao bootstrapping) para calcular os limiares, então pode levar muito tempo!</span></p>
<p>Veja o <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">tutorial sobre GLRNB</a>
para detalhes.</p>
<div class="sourceCode" id="cb1163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina as opções de controle</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## defina qual período de tempo que quer utilizar o limiar (i.e.: 2011)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  mu0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">1</span>,    <span class="co">## número de termos de fourier (harmônicos) para incluir</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co">## incluir tendências ou não</span></span>
<span>  refit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co">## reajustar o modelo após cada alarme ou não</span></span>
<span>  <span class="co">## cARL = limiar para estatísticas GLR (arbitrário)</span></span>
<span>     <span class="co">## 3 ~ meio-termo para minimizar os falsos positivos</span></span>
<span>     <span class="co">## 1 ajusta para os 99% de intervalo de previsão do glm.nb - com mudanças após picos (limiar diminuído para alertas)</span></span>
<span>   c.ARL <span class="op">=</span> <span class="fl">2</span>,</span>
<span>   <span class="co"># theta = log(1.5), ## equivale a um aumento de 50% nos casos em um surto</span></span>
<span>   ret <span class="op">=</span> <span class="st">"cases"</span>     <span class="co">## retorne os limites superiores como contagem de casos</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## aplique o método glrnb</span></span>
<span><span class="va">glrnbmethod</span> <span class="op">&lt;-</span> <span class="fu">glrnb</span><span class="op">(</span><span class="va">counts_sts</span>, control <span class="op">=</span> <span class="va">ctrl</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## crie uma nova variável no conjunto de dados original chamada "threshold"</span></span>
<span><span class="co">## contendo o limite superior do glrnb </span></span>
<span><span class="co">## nb. isto é apenas para as semanas em 2011 (então é necessário subdividir as linhas)</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold_glrnb"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">glrnbmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>Visualize os resultados das análises como mostrado anteriormente.</p>
<div class="sourceCode" id="cb1164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione as quantidades de casos observadas como uma linha</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione o limite superior do algoritmo de aberração</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold_glrnb</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## defina as cores</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## crie um gráfico tradicional (com eixos pretos e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## remova o título da legenda</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_glrnb-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="séries-temporais-interrompidas" class="section level2" number="23.8">
<h2>
<span class="header-section-number">23.8</span> Séries temporais interrompidas<a class="anchor" aria-label="anchor" href="#s%C3%A9ries-temporais-interrompidas"><i class="fas fa-link"></i></a>
</h2>
<p>Séries temporais interrompidas (também chamadas de regressão segmentada ou análise de intervenção),
são usadas frequentemente para avaliar o impacto de vacinas na incidência de doenças.
Mas também pode ser utilizada para avaliar o impacto de uma variedade de intervenções ou introduções.
Por exemplo, alterações nos procedimentos de um hopital, ou introdução de uma nova doença
para a população.
Neste exemplo, nós iremos pretender que uma nova cepa de Campylobacter foi introduzida
na Alemanha no final de 2008, e ver se isso afeta o número de casos.
Iremos utilizar a regressão binominal negativa novamente. Desta vez, a regressão será
dividida em duas partes, uma antes da intervenção (ou introdução da nova cepa neste caso)
e uma após (os períodos pré e pós intervenção/introdução). Isto nos permite calcular uma razão da taxa de incidência comparando
os dois períodos de tempo. Explicar a equação pode clarear isso (se não, somente
ignore!).</p>
<p>A regressão negativa binominal pode ser definida da seguinte forma:</p>
<p><span class="math display">\[\log(Y_t)= β_0 + β_1 \times t+ β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>Onde:
<span class="math inline">\(Y_t\)</span>é o número de casos observado naquele momento <span class="math inline">\(t\)</span><br><span class="math inline">\(pop_t\)</span> é o tamanho da população em 100,000s naquele momento <span class="math inline">\(t\)</span> (não utilizado aqui)<br><span class="math inline">\(t_0\)</span> é o último ano do pré-período (incluindo o tempo de transição, se existir)
<span class="math inline">\(δ(x\)</span> é a função indicadora (será 0 se x≤0 e 1 se x&gt;0)<br><span class="math inline">\((x)^+\)</span> é o operador de corte de acordo com o limite (é x se x&gt;0 e 0 de outra forma)<br><span class="math inline">\(e_t\)</span> denota os resíduos
Termos adicionais sobre tendência e sazonalidade podem ser adicionadas conforme necessário.</p>
<p><span class="math inline">\(β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+\)</span> é a parte linear generalizada
do pós-período e é zero no pré-período.
Isto significa que as estimativas <span class="math inline">\(β_2\)</span> e <span class="math inline">\(β_3\)</span> são efeitos da intervenção.</p>
<p>Nós precisamos recalcular os termos de fourier sem realizar a previsão aqui, uma vez que iremos utilizar
todos os dados disponíveis para nós (i.e.: retrospectivamente). Adicionalmente, nós precisamos calcular
os termos extras necessários para a regressão.</p>
<div class="sourceCode" id="cb1165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## adicione os termos de fourier utilizando as variáveis epiweek e case_int</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## defina a semana de intervenção </span></span>
<span><span class="va">intervention_week</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2008-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## defina as variáveis para a regressão</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## corresponde ao t na fórmula</span></span>
<span>      <span class="co">## contagem das semanas (provavelmente poderia também utilizar diretamente a variável epiweeks (semanas epidemiológicas))</span></span>
<span>    <span class="co"># linear = row_number(epiweek), </span></span>
<span>    <span class="co">## corresponde ao delta(t-t0) na fórmula</span></span>
<span>      <span class="co">## período pré ou pós intervenção</span></span>
<span>    intervention <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>    <span class="co">## corresponde a (t-t0)^+ na fórmula</span></span>
<span>      <span class="co">## contagem de semenas após a intervenção</span></span>
<span>      <span class="co">## (escolha o maior número entre 0 e o que resultar do cálculo)</span></span>
<span>    time_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">epiweek</span> <span class="op">-</span> <span class="va">intervention_week</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Nós então utilizamos estes termos para ajustar uma regressão binominal negativa, e produz uma
tabela com a mudança dos percentuais. O que este exemplo mostra é que não existe
mudanças significativas.</p>
<p><span style="color: orange;"><strong><em>CUIDADO:</em></strong> Observe o uso do argumento <code>simulate_pi = FALSE</code>
dentro de <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Isto ocorre porque o comportamento padrão de <strong>trending</strong>
é utilizar o pacote <strong>ciTools</strong> para estimar o intervalo de previsão. Isto não
funciona se existirem contagens <code>NA</code>, e também produz mais intervalos granulares.
Veja <code>?trending::predict.trending_model_fit</code> para detalhes. </span></p>
<div class="sourceCode" id="cb1166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## defina o modelo que você quer ajustar (binominal negativo)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## defina o número de casos como resultado de interesse da análise</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## utilize a epiweek para levar em consideração a tendência</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## utilize os termos de fourier para levar em consideração a sazonalidade</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## adicione o clima nos pré- e pós- períodos</span></span>
<span>    <span class="va">intervention</span> <span class="op">+</span> </span>
<span>    <span class="co">## adicione o tempo após a intervenção</span></span>
<span>    <span class="va">time_post</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## ajuste seu modelo utilizando os dados de contagem</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calcule os intervalos de confiança e de previsão</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb1167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## mostre as estimativas e mudanças percentuais em uma tabela</span></span>
<span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extraia a regressão original negativa binominal</span></span>
<span>  <span class="fu">get_result</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co">## extrair o primeiro elemento da lista, consequência das alterações de pacotes de tendências.</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html">simplify</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co">## obtenha um quadro de dados organizado dos resultados</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## mantenha apenas o valor da intervenção</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"intervention"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## altere o IRR para diferença de porcentagem para estimativas e invervalos de confiança (CI)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## para cada uma das colunas de interesse - crie uma uma nova coluna</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="co">## aplique a fórmula para calcular a mudança de porcentagem</span></span>
<span>            .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>      <span class="co">## adicione ao nome das novas colunas o sufixo "_perc"</span></span>
<span>      .names <span class="op">=</span> <span class="st">"{.col}_perc"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## apenas mantenha (e renomeie) certas colunas</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"IRR"</span> <span class="op">=</span> <span class="va">estimate</span>, </span>
<span>         <span class="st">"95%CI low"</span> <span class="op">=</span> <span class="va">conf.low</span>, </span>
<span>         <span class="st">"95%CI high"</span> <span class="op">=</span> <span class="va">conf.high</span>,</span>
<span>         <span class="st">"Percentage change"</span> <span class="op">=</span> <span class="va">estimate_perc</span>, </span>
<span>         <span class="st">"95%CI low (perc)"</span> <span class="op">=</span> <span class="va">conf.low_perc</span>, </span>
<span>         <span class="st">"95%CI high (perc)"</span> <span class="op">=</span> <span class="va">conf.high_perc</span>,</span>
<span>         <span class="st">"p-value"</span> <span class="op">=</span> <span class="va">p.value</span><span class="op">)</span></span></code></pre></div>
<p>Como anteriormente, nós podemos visualizar os resultados da regressão.</p>
<div class="sourceCode" id="cb1168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione as quantidades de casos observadas como uma linha</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha para a estimativa do modelo</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span>, col <span class="op">=</span> <span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma banda para os intervalos de previsão</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## adicione uma linha vertical e uma etiqueta para mostrar onde a previsão começou</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Intervention"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">intervention_week</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## defina as cores</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Estimate"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faça um gráfico tradicional (com eixos pretos e fundo branco)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Unknown or uninitialised column: `upper_pi`.</code></pre>
<pre><code>## Warning in max(observed$upper_pi): no non-missing arguments to max; returning -Inf</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/plot_interrupted-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="recursos-14" class="section level2" number="23.9">
<h2>
<span class="header-section-number">23.9</span> Recursos<a class="anchor" aria-label="anchor" href="#recursos-14"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://otexts.com/fpp3/">previsões: texto sobre princípios e práticas</a><br><a href="https://github.com/EPIET/TimeSeriesAnalysis">Estudos de caso EPIET sobre séries temporais</a><br><a href="https://online.stat.psu.edu/stat510/lesson/1">Curso da Penn State</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Artigo sobre o pacote surveillance</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="moving-average.html"><span class="header-section-number">22</span> Médias móveis</a></div>
<div class="next"><a href="epidemic-models.html"><span class="header-section-number">24</span> Modelagem de epidemias</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#time-series"><span class="header-section-number">23</span> Séries temporais e detecção de surtos</a></li>
<li><a class="nav-link" href="#vis%C3%A3o-geral-do-t%C3%B3pico"><span class="header-section-number">23.1</span> Visão geral do tópico</a></li>
<li>
<a class="nav-link" href="#prepara%C3%A7%C3%A3o-13"><span class="header-section-number">23.2</span> Preparação</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#carregue-os-pacotes-r-4">Carregue os pacotes R</a></li>
<li><a class="nav-link" href="#carregue-os-dados-no-r">Carregue os dados no R</a></li>
<li><a class="nav-link" href="#limpe-os-dados">Limpe os dados</a></li>
<li><a class="nav-link" href="#baixe-download-os-dados-clim%C3%A1ticos">Baixe (download) os dados climáticos</a></li>
<li><a class="nav-link" href="#carregue-os-dados-clim%C3%A1ticos">Carregue os dados climáticos</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#dados-de-s%C3%A9ries-temporais"><span class="header-section-number">23.3</span> Dados de séries temporais</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#dados-duplicados">Dados duplicados</a></li>
<li><a class="nav-link" href="#campos-em-branco">Campos em branco</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#an%C3%A1lise-descritiva"><span class="header-section-number">23.4</span> Análise descritiva</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#timeseries_moving">Médias móveis</a></li>
<li><a class="nav-link" href="#peridiocidade">Peridiocidade</a></li>
<li><a class="nav-link" href="#decomposi%C3%A7%C3%A3o">Decomposição</a></li>
<li><a class="nav-link" href="#autocorrela%C3%A7%C3%A3o">Autocorrelação</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ajustando-regress%C3%B5es"><span class="header-section-number">23.5</span> Ajustando regressões</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#termos-de-fourier">Termos de Fourier</a></li>
<li><a class="nav-link" href="#binominal-negativa">Binominal negativa</a></li>
<li><a class="nav-link" href="#res%C3%ADduos">Resíduos</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#rela%C3%A7%C3%A3o-entre-duas-s%C3%A9ries-temporais"><span class="header-section-number">23.6</span> Relação entre duas séries temporais</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#unindo-bancos-de-dados">Unindo bancos de dados</a></li>
<li><a class="nav-link" href="#an%C3%A1lise-descritiva-1">Análise descritiva</a></li>
<li><a class="nav-link" href="#lags-e-correla%C3%A7%C3%A3o-cruzada">Lags e correlação cruzada</a></li>
<li><a class="nav-link" href="#binominal-negativa-com-duas-vari%C3%A1veis">Binominal negativa com duas variáveis</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#detec%C3%A7%C3%A3o-de-surtos"><span class="header-section-number">23.7</span> Detecção de surtos</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#pacote-trending">Pacote trending</a></li>
<li><a class="nav-link" href="#pacote-surveillance">Pacote surveillance</a></li>
</ul>
</li>
<li><a class="nav-link" href="#s%C3%A9ries-temporais-interrompidas"><span class="header-section-number">23.8</span> Séries temporais interrompidas</a></li>
<li><a class="nav-link" href="#recursos-14"><span class="header-section-number">23.9</span> Recursos</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Manual de R para Epidemiologistas</strong>" was written by the handbook team. It was last built on 2023-10-24.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
